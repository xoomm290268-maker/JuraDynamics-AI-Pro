<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juristische Fallanalyse Prototyp (Universal)</title>
    <!-- Firebase CDNs f√ºr persistente Datenspeicherung -->
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Ruhige Seriosit√§t (Dunkelblau, Hellgrau, Akzent: Goldgelb) -->
    <style>
        /* Stabilisierung: Allgemeine Styles beibehalten */
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .nav-link { transition: all 0.2s ease; border-left: 4px solid transparent; }
        .nav-link.active { border-left-color: #FBBF24; font-weight: 600; }
        
        /* KORREKTUR: Max-Width und Height f√ºr bessere mobile Lesbarkeit angepasst */
        .chart-container { position: relative; width: 100%; max-width: 100%; height: 280px; margin-left: auto; margin-right: auto; max-height: 350px; }
        @media (min-width: 1024px) { 
             .chart-container { max-width: 450px; } 
        }

        .content-area { display: none; }
        .content-area.active { display: block; }
        .accordion-header { cursor: pointer; user-select: none; }
        .highlight { background-color: #FBBF24; font-weight: 700; padding: 1px 3px; border-radius: 3px; transition: background-color 0.3s ease; }

        /* NEU: Print Optimierung */
        @media print {
            /* FIX: Stellt sicher, dass die Sidebar und die Export-Buttons NICHT gedruckt werden */
            .sidebar-nav, header .flex.space-x-2 { display: none !important; }
            main { padding: 0 !important; margin: 0 !important; }
            .flex { display: block; height: auto !important; }
            .content-area { display: block !important; margin-bottom: 20px; border: 1px solid #ccc; padding: 10px; page-break-inside: avoid; }
            .chart-container { max-width: 100% !important; height: auto !important; }
            h1, h2, h3 { color: #000 !important; }
        }
        /* Risiko Farbschema */
        .strength-HIGH { border-left-color: #ef4444; background-color: #fee2e2; }
        .strength-MEDIUM { border-left-color: #FBBF24; background-color: #fffbeb; }
        /* Task Status */
        .task-open { border-left-color: #f97316; }
        .task-done { border-left-color: #10b981; background-color: #ecfdf5; }
        
        /* NEU: Fokus Modus Klassen */
        .app-container.focus-mode .sidebar-nav { display: none; }
        .app-container.focus-mode .main-content { margin-left: 0; width: 100%; }
        .app-container.focus-mode .main-content header { max-width: 90%; }

        /* NEU: Chat spezifisches CSS */
        .chat-container { height: 500px; overflow-y: auto; display: flex; flex-direction: column; }
        .chat-message { max-width: 85%; padding: 8px 12px; border-radius: 12px; margin-bottom: 10px; word-wrap: break-word; }
        .user-message { background-color: #3b82f6; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .ai-message { background-color: #e5e7eb; color: #1f2937; align-self: flex-start; border-bottom-left-radius: 2px; }
        .dark .ai-message { background-color: #4b5563; color: #f9fafb; }
        .loading-dot { display: inline-block; width: 8px; height: 8px; margin-left: 2px; border-radius: 50%; background-color: #6b7280; animation: bounce 1s infinite alternate; }
        .loading-dot:nth-child(2) { animation-delay: 0.3s; }
        .loading-dot:nth-child(3) { animation-delay: 0.6s; }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-5px); }
        }

        /* Drag & Drop Feedback Klasse */
        .drop-zone-active { 
            border: 3px dashed #FBBF24 !important;
            background-color: #fffbeb !important;
        }

        /* Loading Overlay f√ºr Strategie/To-Do-Generierung */
        #ai-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 600;
            color: #1e40af;
            border-radius: 8px;
            z-index: 10;
        }
        .dark #ai-loading-overlay {
            background-color: rgba(31, 41, 55, 0.9);
            color: #60a5fa;
        }
        
        /* Stabilisierung: Dark Mode Anpassungen */
        .dark .bg-gray-100 { background-color: #111827; } 
        .dark .bg-white { background-color: #1f2937; }  
        .dark .text-gray-800 { color: #f9fafb; } 
        .dark .text-gray-900 { color: #f9fafb; } /* High Contrast Text */
        .dark .text-gray-500 { color: #9ca3af; } 
        .dark .text-gray-600 { color: #d1d5db; } 
        .dark .text-gray-700 { color: #d1d5db; } /* Textfarbe f√ºr Beschriftungen */
        .dark .border-b { border-color: #374151; } 
        .dark .bg-gray-50 { background-color: #374151; } 
        
        /* Dark Mode f√ºr dynamische Komponenten und Inputs */
        .dark input, .dark textarea, .dark pre { background-color: #1f2937 !important; border-color: #4b5563 !important; color: #f9fafb !important; }
        .dark .timeline-item { background-color: #1f2937; border-color: #4b5563; }
        .dark .task-open { background-color: #1f2937; }
        .dark .shadow-md { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.4), 0 2px 4px -2px rgba(0,0,0,0.4); }
        
        /* KORREKTUR: Blau in Dark Mode auf Hellblau (blue-400) setzen */
        .dark .text-blue-900 { color: #60a5fa !important; } /* blue-400 */
        .dark .text-blue-700 { color: #93c5fd !important; } /* blue-300 */
        .dark .text-blue-800 { color: #93c5fd !important; } /* blue-300 (z.B. f√ºr Card-Titel) */
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen app-container">
        <!-- Sidebar Navigation (Jetzt immer sichtbar) -->
        <aside id="sidebar" class="w-64 bg-white shadow-lg p-4 flex-col sidebar-nav flex h-full">
            <!-- Branding angepasst -->
            <h1 class="text-2xl font-bold text-gray-900 mb-2">‚öñÔ∏è JuraDynamics AI Pro</h1>
            
            <!-- KORRIGIERTER TEXT -->
            <p class="text-xs text-green-500 font-semibold mb-3">Die All-in-One L√∂sung. Prozesssicherheit, Zeitersparnis und strategischer Druck ‚Äì **in einem Klick**.</p>
            
            <p class="text-xs text-gray-700 font-semibold mb-3">Dieses **Automatisierungstool** bietet einen neuen Level in der Rechtsanwaltsarbeit und die n√§chste Stufe des juristischen Arbeitsmanagements. Es bietet **52+ generative KI-Anwendungen** zur Fallanalyse und Korrespondenz. Profitiere von un√ºbertroffenem **Qualit√§tsmanagement**, das in jeder Funktion verankert ist. Je nach Anwendungsszenario erzielst du eine **Zeitersparnis von bis zu 80%**.</p>
            <!-- ENDE KORRIGIERTER TEXT -->

            <!-- NEU: Zeitersparnis Statistik -->
            <div class="mb-6 p-3 bg-gray-50 rounded-lg border border-gray-200">
                <h4 class="text-xs font-bold text-blue-900 mb-2 uppercase">Zeitersparnis (√ò pro Fall)</h4>
                <div class="space-y-1">
                    <p class="text-xs text-gray-700">Strategie & Due Diligence: <span class="font-bold text-red-600">min. 3.0 Std</span></p>
                    <p class="text-xs text-gray-700">Juristische Recherche: <span class="font-bold text-red-600">min. 2.0 Std</span></p>
                    <p class="text-xs text-gray-700">Dokumente & Abrechnung: <span class="font-bold text-red-600">min. 1.5 Std</span></p>
                    <p class="text-sm font-bold text-blue-800 border-t mt-1 pt-1">Gesamt: min. 6.5 Stunden</p>
                    <!-- HINZUGEF√úGT: Klarstellung -->
                    <p class="text-xs text-gray-500 italic mt-1">(Gilt f√ºr die o.g. drei Anwendungen)</p> 
                </div>
            </div>
            
            <nav class="flex flex-col space-y-2 border-t pt-3">
                <!-- KORREKTUR: Textfarbe auf text-gray-800 gesetzt (Dark Mode wird dynamisch zugewiesen) -->
                <a href="#data-input" class="nav-link py-2 px-4 rounded-md text-gray-800 hover:bg-gray-50" data-target="data-input">Daten-Management</a>
                <a href="#overview" class="nav-link active py-2 px-4 rounded-md text-gray-800 hover:bg-gray-50" data-target="overview">√úbersicht & Finanzen</a>
                <a href="#timeline" class="nav-link py-2 px-4 rounded-md text-gray-800 hover:bg-gray-50" data-target="timeline">Chronologie & Eskalation</a>
                <a href="#evidence" class="nav-link py-2 px-4 rounded-md text-gray-800 hover:bg-gray-50" data-target="evidence">Beweislage & Zeugen</a>
                <a href="#violations" class="nav-link py-2 px-4 rounded-md text-gray-800 hover:bg-gray-50" data-target="violations">Rechtsverst√∂√üe (StGB)</a>
                <a href="#raw-text-viewer" class="nav-link py-2 px-4 rounded-md text-gray-800 hover:bg-gray-50" data-target="raw-text-viewer">Quelltext-Analyse</a>
                <a href="#next-steps" class="nav-link py-2 px-4 rounded-md text-gray-800 hover:bg-gray-50" data-target="next-steps">Strategie & Konsequenzen</a>
                <a href="#tasks" class="nav-link py-2 px-4 rounded-md text-gray-800 hover:bg-gray-50" data-target="tasks">Aktionsplan (To-Do)</a>
                <!-- NEU: KI Chat Link -->
                <a href="#ai-chat" class="nav-link py-2 px-4 rounded-md text-gray-800 hover:bg-gray-50" data-target="ai-chat">ü§ñ KI-Dokumenten-Chat</a>
                <!-- NEU: Urteilsanalyse Link -->
                <a href="#judgment-analysis" class="nav-link py-2 px-4 rounded-md text-gray-800 hover:bg-gray-50" data-target="judgment-analysis">üèõÔ∏è Urteilsanalyse</a>
                <!-- NEU: BRAO Compliance Link -->
                <a href="#brao-compliance" class="nav-link py-2 px-4 rounded-md text-gray-800 hover:bg-gray-50" data-target="brao-compliance">üìú BRAO-Compliance</a>
            </nav>
            <div class="mt-auto pt-4 border-t text-sm text-gray-500">
                 <!-- Angepasst -->
                <p>Status: PoC v12.4 (Anonymisierungskonzept)</p> <!-- Version erh√∂ht -->
                <p class="text-xs text-gray-400" id="user-status">Authentifizierung l√§uft...</p>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto p-8 main-content">
            <header class="mb-8 flex justify-between items-center">
                
                <!-- Mobiles Men√º-Button wurde dauerhaft entfernt. -->
                
                <div>
                    <!-- KORREKTUR: Titel auf text-gray-900 -->
                    <h2 class="text-3xl font-semibold text-gray-900" id="case-title">Fall: [Bitte Daten laden]</h2>
                    <p class="text-gray-700 mt-1" id="case-subtitle">Laden Sie die Falldaten √ºber den Men√ºpunkt "Daten-Management" oder nutzen Sie die Demo-Daten.</p>
                </div>
                <!-- Export Buttons -->
                <div class="flex space-x-2">
                    <!-- JSON Export Button wurde verschoben -->
                    <button onclick="window.print()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md" title="Generiert eine druckbare Version des gesamten Analyseberichts.">
                        Bericht exportieren üñ®Ô∏è
                    </button>
                    <button id="toggle-focus-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md" title="Schaltet in den Vollbild-Fokusmodus zur besseren Lesbarkeit des Quelltexts.">
                        Fokus-Modus üìñ
                    </button>
                    <button id="toggle-dark-mode-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md" title="Wechselt zwischen hellem und dunklem Design.">
                        Nachtmodus üåô
                    </button>
                </div>
            </header>
            
            <!-- 0. Daten-Management -->
            <section id="data-input" class="content-area">
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-xl font-bold text-blue-900 mb-4">Hybrid-Input & Analyse-Start</h3>
                    <p class="text-sm text-gray-700 mb-6">Geben Sie die wichtigsten Daten strukturiert ein (manuell/KI-Extraktion) und den Rohtext als Basis f√ºr die Detailanalyse.</p>
                    
                    <!-- NEU: KI API KEY INPUTS (NUR GEMINI) -->
                    <h4 class="text-lg font-bold text-gray-900 mb-3 border-b pt-4">API-Schl√ºssel (f√ºr lokale KI-Funktionen)</h4>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-red-700">Gemini API Key (N√∂tig f√ºr Strategie/Chat) - HINWEIS: Wird nun im Worker verwaltet, aber zur Validierung ben√∂tigt.</label>
                        <!-- HIER: Nur der Gemini Key als Platzhalter eingef√ºgt -->
                        <input type="password" id="input-api-key" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-yellow-50 text-gray-900" 
                                placeholder="WORKER_PROXY_IN_USE">
                        <p class="text-xs text-gray-500 mt-1">Dieser Schl√ºssel wird f√ºr die Funktionen "KI-Aktionsplan" und "KI-Chat" ben√∂tigt. Er wird √ºber einen Proxy gesendet.</p>
                    </div>
                    
                    <!-- Structured Input Fields -->
                    <h4 class="text-lg font-bold text-gray-900 mb-3 border-t pt-4">Falldaten (Manuell)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Titel des Falls (Kl√§ger vs. Beklagter)</label>
                            <input type="text" id="input-caseName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 text-gray-900" placeholder="Schroeter vs. Spickermann KFZ GmbH">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Forderung (Schmerzensgeld in ‚Ç¨)</label>
                            <input type="number" id="input-schmerzensgeld" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 text-gray-900" placeholder="2500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Gezahlter Betrugsschaden (‚Ç¨)</label>
                            <input type="number" id="input-bezahlterBetrug" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 text-gray-900" placeholder="47">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Wichtigste Frist (Freitext/TT.MM.JJJJ)</label>
                            <!-- KORREKTUR: Container f√ºr Frist-Input und Button -->
                            <div class="flex space-x-2 mt-1">
                                <input type="text" id="input-frist" class="block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 text-gray-900" placeholder="z.B. 14 Tage ab heute oder 15.10.2025">
                                <button id="extract-date-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md" title="Nutzt KI, um ein Datum aus Freitext-Eingaben wie '14 Tage ab heute' oder 'Mitte n√§chsten Monats' zu erkennen.">
                                    ‚ú® KI-Frist erkennen
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Rohtext / OCR Simulation -->
                    <h4 class="text-lg font-bold text-gray-900 mb-3 border-t pt-4">Rohtext des Dokuments (Simulierte OCR/KI-Extraktion)</h4>
                    <p class="text-xs text-gray-700 mb-2">Laden Sie Ihr Dokument (Foto/PDF) hoch. Der extrahierte Text dient als Basis f√ºr die Analyse.</p>
                    
                    <label for="file-upload" class="cursor-pointer inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 mb-3 text-sm" title="Simuliert das Hochladen eines Dokuments und f√ºllt das Rohtextfeld.">
                        Dokument hochladen / Foto aufnehmen üì∏
                        <input type="file" id="file-upload" class="hidden" accept="image/*" capture="environment"/>
                    </label>

                     <!-- HINZUGEF√úGT: Warnhinweis zur Anonymisierung -->
                    <div class="mb-4 p-3 bg-orange-100 border border-orange-400 rounded-lg text-xs text-orange-800 font-semibold">
                        üîí **Anonymisierungs-Konzept (Experimentell):** Eine Beispiel-Funktion zur Pseudonymisierung (`anonymizeLegalDocument`) ist im Code enthalten, aber **nicht standardm√§√üig aktiv**. Diese Funktion ist **nur ein einfaches Beispiel** und bietet **keinen zuverl√§ssigen Schutz** f√ºr sensible Daten gem√§√ü DSGVO. Echte Anonymisierung erfordert spezialisierte NLP-Werkzeuge. Aktivieren Sie diese Funktion nur zu Testzwecken und auf eigene Gefahr.
                    </div>
                    
                    <textarea id="raw-text-input" class="w-full h-48 p-4 border border-gray-300 rounded-lg font-mono text-xs focus:ring-blue-500 focus:border-blue-500 bg-gray-50 text-gray-900" placeholder="[Rohtext hier einf√ºgen... Alle Details, die Paragraphen, die Zitate etc.]"></textarea>
                    
                    <!-- NEU: Datenschutz- und Haftungshinweis f√ºr Daten-Management -->
                    <div class="mt-4 p-3 bg-red-100 border border-red-400 rounded-lg text-xs text-red-800 font-semibold">
                        ‚ö†Ô∏è **Wichtiger Hinweis zu Datenschutz & Haftung:** Der Nutzer ist allein f√ºr die Einhaltung der Datenschutzbestimmungen (DSGVO) verantwortlich. Es d√ºrfen nur anonymisierte oder zur Verarbeitung freigegebeDokumente hochgeladen werden. Dieses Tool bietet keine Rechtsberatung, die KI-Ergebnisse dienen lediglich der Unterst√ºtzung.
                    </div>
                    
                    <div class="flex justify-between items-center mt-4 border-b pb-4">
                        <!-- STABILISIERUNG: Ruft die gesamte Kette auf (startFullAnalysis) -->
                        <button id="analyze-data-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150" title="F√ºhrt die vollst√§ndige Fallanalyse durch: Finanzdaten, Beweise, Paragraphen, Strategie und To-Do-Punkte in einem Klick.">
                            ‚ú® Gesamtanalyse starten
                        </button>
                         <!-- NEU: Abbrechen Button -->
                        <button id="abort-ki-btn" class="hidden bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md" title="Bricht den aktuellen KI-Generierungsvorgang ab.">
                            ‚ùå Generierung abbrechen
                        </button>
                        <p id="status-message" class="text-sm text-red-500"></p>
                    </div>
                    
                    <!-- NEU: Best-Practice-Template-Extraktor Button -->
                    <div class="flex justify-start items-center mt-4 border-b pb-4">
                         <button id="generate-template-extractor-btn" class="bg-green-700 hover:bg-green-800 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Extrahiert alle mandantenspezifischen Daten aus dem Rohtext, um eine generische und wiederverwendbare Markdown-Vorlage zu erstellen.">
                            ‚ú® Best-Practice-Template-Extraktor
                        </button>
                        <span class="text-xs text-gray-500 ml-3">Kosten: 6 Credits</span>
                    </div>

                    <!-- NEU: Aktenstruktur-Mapper Button -->
                    <div class="flex justify-start items-center mt-4 border-b pb-4">
                         <button id="generate-actor-mapper-btn" class="bg-gray-700 hover:bg-gray-800 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Generiert eine interaktive HTML-Netzwerkvisualisierung aller beteiligten Akteure (Parteien, Zeugen, Firmen, Orte) und ihrer Beziehungen.">
                            üåê Visueller Aktenstruktur-Mapper
                        </button>
                        <span class="text-xs text-gray-500 ml-3">Kosten: 9 Credits</span>
                    </div>

                    <!-- NEU: DSGVO Audit Report Button -->
                    <div class="flex justify-start items-center mt-4 border-b pb-4">
                        <button id="generate-audit-btn" class="bg-pink-600 hover:bg-pink-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Generiert einen internen DSGVO-Audit-Bericht zur Compliance und den Speicherungsrisiken des Falles.">
                            ‚ú® DSGVO-Audit-Bericht erstellen
                        </button>
                        <span class="text-xs text-gray-500 ml-3">Kosten: 2 Credits</span>
                    </div>

                    <!-- Persistence & Demo - Jetzt mit klarer Unterscheidung Cloud/Lokal -->
                    <h4 class="text-lg font-bold text-gray-900 mb-3 border-t pt-4">Fall-Speicherung (Cloud oder Lokal)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- CLOUD SPEICHERUNG -->
                        <div class="p-4 bg-gray-50 rounded-lg border border-green-300">
                            <p class="text-sm font-semibold text-green-700 mb-2">Cloud-Speicherung (Firestore)</p>
                            <p class="text-xs text-gray-700 mb-3">Speichert die Falldaten automatisch und persistent in der Cloud. Ideal f√ºr Kanzleien.</p>
                            <button id="save-case-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm w-full disabled:opacity-50" disabled>Fall speichern (Cloud) üíæ</button>
                        </div>
                        
                        <!-- LOKALE SPEICHERUNG -->
                        <div class="p-4 bg-gray-50 rounded-lg border border-gray-300">
                            <p class="text-sm font-semibold text-gray-700 mb-2">Lokale Speicherung (.json)</p>
                            <p class="text-xs text-gray-700 mb-3">Speichert/l√§dt den Fall als JSON-Datei direkt auf Ihren Computer. Ideal f√ºr Backup oder Offline-Arbeit.</p>
                            <div class="flex space-x-2">
                                <button id="export-json-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm flex-1" title="Exportiert die gesamte Fallakte und Analyse als JSON-Datei auf Ihren lokalen Rechner.">
                                    Analyse exportieren
                                </button>
                                <label for="json-upload" class="cursor-pointer bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm flex-1 text-center" title="Importiert eine zuvor exportierte JSON-Datei und l√§dt die Falldaten.">
                                    JSON-Analyse importieren
                                    <input type="file" id="json-upload" class="hidden" accept=".json"/>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 flex justify-end">
                        <button id="load-demo-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-900 font-semibold py-1.5 px-3 rounded-lg transition duration-150 text-sm" title="L√§dt einen vordefinierten Demo-Fall, um die Funktionen zu testen.">Schroeter Demo laden</button>
                    </div>

                </div>
                
                <!-- Fall-Liste (wird dynamisch geladen) -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-blue-900 mb-4 border-b pb-2">Gespeicherte F√§lle (Cloud)</h3>
                    <div id="case-list-container" class="space-y-3">
                        <p class="text-gray-500 text-sm">Keine gespeicherten F√§lle gefunden. Bitte Fall speichern.</p>
                    </div>
                </div>
            </section>

            <!-- 1. √úbersicht & Finanzen -->
            <section id="overview" class="content-area active">
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-xl font-bold text-blue-900 mb-4">Finanzielle √úbersicht und Kern-Fakten</h3>
                    <p class="text-sm text-gray-700 mb-6">Dieser Abschnitt visualisiert die finanziellen Dimensionen des Falls und liefert die wichtigsten Kennzahlen zur schnellen Erfassung.</p>

                    <div id="deadline-warning" class="p-4 rounded-lg mb-6 flex items-center">
                        <!-- Countdown wird hier eingef√ºgt -->
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6" id="overview-cards">
                        <!-- Cards will be dynamically populated -->
                        <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-600">
                            <p class="text-sm text-gray-500">Geforderter Schadenersatz</p>
                            <p class="text-2xl font-bold text-blue-800 mt-1" data-stat="schmerzensgeld">0,00 ‚Ç¨</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-600">
                            <p class="text-sm text-gray-500">Betrugsschaden (Gezahlt)</p>
                            <p class="text-2xl font-bold text-yellow-800 mt-1" data-stat="bezahlterBetrug">0,00 ‚Ç¨</p>
                        </div>
                           <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-600">
                            <p class="text-sm text-gray-500">Wichtigste Frist</p>
                            <p class="text-2xl font-bold text-red-800 mt-1" data-stat="frist">N.A.</p>
                        </div>
                    </div>
                    
                    <!-- NEU: RVG Kosten W√§chter Button -->
                    <div class="flex justify-start items-center mt-6 border-b pb-4">
                        <button id="generate-rvg-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Generiert eine detaillierte RVG-Kostenberechnung (Markdown) basierend auf Streitwert und Strategie. Sichert das Honorar.">
                            üí∞ RVG-Kosten-W√§chter (Kalkulation)
                        </button>
                        <span class="text-xs text-gray-500 ml-3">Kosten: 2 Credits</span>
                    </div>

                     <!-- NEU: RVG Justifizierer Button -->
                    <div class="flex justify-start items-center mt-4 border-b pb-4">
                        <button id="generate-justification-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Generiert eine juristisch fundierte Begr√ºndung (Narrative) f√ºr die angesetzten Geb√ºhren basierend auf der Komplexit√§t des Falles.">
                            ‚úçÔ∏è RVG-Abrechnungs-Justifizierer
                        </button>
                        <span class="text-xs text-gray-500 ml-3">Kosten: 5 Credits</span>
                    </div>
                    
                    <!-- NEU: Schadenauswirkungs-Dashboard Button -->
                    <div class="flex justify-start items-center mt-4 border-b pb-4">
                        <button id="generate-impact-dashboard-btn" class="bg-pink-600 hover:bg-pink-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Generiert einen interaktiven HTML-Bericht (Dashboard), der die wichtigsten Fakten, Fristen und Risiken grafisch zusammenfasst.">
                            ‚ú® Beweis- & Schadenauswirkungs-Dashboard
                        </button>
                        <span class="text-xs text-gray-500 ml-3">Kosten: 10 Credits</span>
                    </div>


                    <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-3">Vergleich Forderungen vs. Verlust</h4>
                            <div class="chart-container">
                                   <canvas id="financialsChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- NEU: Szenario-Simulation -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-3 border-b pb-2">Szenario-Simulation: Vergleichsrisiko</h4>
                             <p class="text-sm text-gray-700 mb-4">Geben Sie einen hypothetischen Vergleichsbetrag ein, um die Kosten im Vergleich zum Prozessrisiko zu sehen.</p>
                            
                            <label class="block text-sm font-medium text-gray-700">Hypothetischer Vergleichsbetrag (‚Ç¨)</label>
                            <input type="number" id="input-hypo-settlement" value="1500" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 mb-4 bg-gray-50 text-gray-900" placeholder="1500"> <!-- oninput entfernt, da es √ºber den Event Listener in JS gehandhabt wird -->

                             <div class="chart-container">
                                 <canvas id="scenarioChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Kommentar-Sektion -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h4 class="text-lg font-bold text-blue-900 mb-3">Strategische Anmerkungen (√úbersicht)</h4>
                    <textarea id="notes-overview" class="w-full h-24 p-3 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-50 text-gray-900" placeholder="Ihre Notizen hier speichern..."></textarea>
                    <!-- STABILISIERUNG: Hinweis auf Speicherung auch bei manuellem Speichern -->
                    <p class="text-xs text-gray-500 mt-1">Diese Notizen werden zusammen mit dem Fall in Firestore gespeichert, wenn Sie auf 'Fall speichern' klicken.</p>
                </div>
            </section>

            <!-- 2. Chronologie & Eskalation -->
            <section id="timeline" class="content-area">
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-xl font-bold text-blue-900 mb-4">Ereigniskette und Eskalationspunkte</h3>
                    <!-- Hinzugef√ºgte √úberschrift -->
                    <p class="text-sm text-gray-700 mb-6">Der interaktive Zeitstrahl zeigt, wie die Eskalation durch die Ignoranz der Gegenseite vorangetrieben wurde.</p>

                    <div id="timeline-list" class="space-y-4">
                        <p class="text-gray-500">Bitte Daten laden.</p>
                    </div>
                       <div id="timeline-detail-box" class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200 hidden">
                        <p class="font-semibold text-gray-900 mb-1" id="timeline-detail-title"></p>
                        <p class="text-sm text-gray-700" id="timeline-detail-text"></p>
                    </div>
                    
                    <!-- NEU: Gerichtliche Pr√§sentations-Generator Button -->
                    <div class="flex justify-start items-center mt-6 border-t pb-4">
                        <button id="generate-presentation-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Generiert eine visuell aufbereitete Pr√§sentation (Markdown) der Chronologie und zentralen Fakten f√ºr interne Besprechungen oder Gerichtsverhandlungen.">
                            ‚ú® Gerichtliche Pr√§sentations-Generator
                        </button>
                        <span class="text-xs text-gray-500 ml-3">Kosten: 2 Credits</span>
                    </div>

                    <!-- NEU: Dynamischer Eskalations-W√§chter Button -->
                    <div class="flex justify-start items-center mt-4 border-b pb-4">
                        <button id="generate-escalation-watcher-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Bewertet das Frist-Risiko neu und erstellt einen Zeitstrahl f√ºr den Prozess basierend auf Gegner-Score und Beweislage.">
                            ‚è∞ Dynamischer Eskalations-W√§chter
                        </button>
                        <span class="text-xs text-gray-500 ml-3">Kosten: 7 Credits</span>
                    </div>
                    
                </div>
            </section>

            <!-- 3. Beweislage & Zeugen -->
            <section id="evidence" class="content-area">
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-xl font-bold text-blue-900 mb-4">Beweise und zentrale Aussagen</h3>
                    <p class="text-sm text-gray-700 mb-6">Filtern Sie nach Beweisst√§rke oder klicken Sie auf eine Karte, um das Zitat im Quelltext hervorzuheben.</p>
                    
                    <!-- Filter -->
                    <div class="mb-4 flex space-x-3">
                        <button class="filter-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1 px-3 rounded-full text-xs transition duration-150 active-filter" data-filter="ALL">Alle Beweise</button>
                        <button class="filter-btn bg-red-100 hover:bg-red-200 text-red-800 font-semibold py-1 px-3 rounded-full text-xs transition duration-150" data-filter="HIGH">Hohes Risiko</button>
                        <button class="filter-btn bg-yellow-100 hover:bg-yellow-200 text-yellow-800 font-semibold py-1 px-3 rounded-full text-xs transition duration-150" data-filter="MEDIUM">Mittleres Risiko</button>
                    </div>
                    
                    <!-- NEU: KI-Button f√ºr Beweis-Extraktion -->
                    <div class="mb-6 border-b pb-4 flex justify-between items-center">
                        <button id="generate-evidence-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Extrahiert die st√§rksten Beweiszitate (Snippets) direkt aus dem Rohtext, inklusive einer Risikobewertung.">
                            ‚ú® KI-Beweise extrahieren
                        </button>
                        <span class="text-xs text-gray-500 ml-3">Kosten: 2 Credits</span>
                    </div>
                    
                    <!-- NEU: Deep-Due-Diligence-Scanner Button -->
                    <div class="mb-6 border-b pb-4 flex justify-between items-center">
                        <button id="generate-due-diligence-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Simuliert die Hypothese des gegnerischen Anwalts und identifiziert die Schwachstellen in der eigenen Beweiskette.">
                            ‚ú® Deep-Due-Diligence-Scanner
                        </button>
                        <span class="text-xs text-gray-500 ml-3">Kosten: 7 Credits</span>
                    </div>

                    <!-- NEU: Kausalit√§ts-Maximierer Button -->
                    <div class="mb-6 border-b pb-4 flex justify-between items-center">
                        <button id="generate-causality-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Erstellt eine juristische Kausalit√§tskette im Gutachten-Stil, um die Forderung (z.b. Schmerzensgeld) l√ºckenlos zu untermauern.">
                            ‚ú® Kausalit√§ts-Maximierer (Gutachten)
                        </button>
                        <span class="text-xs text-gray-500 ml-3">Kosten: 6 Credits</span>
                    </div>
                    
                    <!-- NEU: BEWEISL√úCKEN-SCANNER BUTTON -->
                    <div class="mb-6 border-b pb-4 flex justify-between items-center">
                        <button id="generate-gap-analysis-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Vergleicht die juristischen Notwendigkeiten mit den vorhandenen Beweisen und erstellt eine Checkliste der fehlenden Unterlagen.">
                            ‚ú® Beweisl√ºcken-Scanner & Anforderungskatalog
                        </button>
                        <span class="text-xs text-gray-500 ml-3">Kosten: 5 Credits</span>
                    </div>

                    <div id="evidence-container" class="space-y-4">
                        <p class="text-gray-500">Bitte Daten laden.</p>
                    </div>
                </div>
            </section>

            <!-- 4. Rechtsverst√∂√üe (StGB) -->
            <section id="violations" class="content-area">
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h3 class="text-xl font-bold text-blue-900 mb-4">Strafrechtliche Einordnung</h3>
                    <p class="text-sm text-gray-700 mb-6">Die folgenden Delikte wurden durch Mitarbeiter und Gesch√§ftsf√ºhrer begangen, basierend auf den vorliegenden Zeugenaussagen und der Chronologie.</p>
                    
                    <!-- NEU: KI-Button f√ºr Paragraphen-Identifikation -->
                    <div class="mb-6 border-b pb-4 flex justify-between items-center">
                        <button id="generate-violations-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Identifiziert relevante Paragraphen (StGB, BGB) basierend auf dem Sachverhalt und der Beweislage.">
                            ‚ú® KI-Paragraphen identifizieren
                        </button>
                            <span class="text-xs text-gray-500 mt-2">Kosten: 1 Credit</span>
                    </div>

                    <div id="violations-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <p class="text-gray-500">Bitte Daten laden.</p>
                    </div>
                </div>
            </section>

             <!-- 5. Quelltext-Analyse -->
            <section id="raw-text-viewer" class="content-area">
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-xl font-bold text-blue-900 mb-4">Quelltext des Dokuments (Mit Highlighting)</h3>
                    <p class="text-sm text-gray-700 mb-6">Dies ist der extrahierte Text. Klicken Sie auf Beweise in der "Beweislage", um die relevanten Zitate hier hervorzuheben.</p>
                    <pre id="highlighted-text" class="w-full h-96 p-4 border border-gray-300 rounded-lg bg-gray-50 font-mono text-xs overflow-auto whitespace-pre-wrap text-gray-900">Rohtext laden...</pre>
                </div>
            </section>

            <!-- 6. Strategie & Konsequenzen -->
            <section id="next-steps" class="content-area">
                <div class="bg-white p-6 rounded-lg shadow-md mb-8 relative">
                    <!-- Loading Overlay f√ºr KI-Generierung -->
                    <div id="strategy-loading-overlay" class="hidden" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
                        <div id="ai-loading-overlay">KI generiert Strategie...</div>
                    </div>

                        <h3 class="text-xl font-bold text-blue-900 mb-4">Strategie und Maximierung des Drucks</h3>
                    <p class="text-sm text-gray-700 mb-6">Nach Ablauf der finalen Frist erfolgt die konsequente Einleitung aller rechtlichen und gewerberechtlichen Schritte. Die Akkordeons zeigen die Details der einzelnen Konsequenzebenen.</p>
                    
                    <!-- NEU: KI-Button f√ºr Strategie-Generierung -->
                    <div class="mb-6 border-b pb-4 flex justify-between items-center">
                        <button id="generate-strategy-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Erstellt einen dreistufigen Plan (Strafrecht, Zivilrecht, √ñffentlich) zur Maximierung des Drucks auf die Gegenseite.">
                            ‚ú® KI-Aktionsplan erstellen
                        </button>
                        <span class="text-xs text-gray-500 ml-3">Kosten: 2 Credits</span>
                    </div>
                    
                    <!-- NEU: Strategische Synthese Button -->
                    <div class="mb-6 border-b pb-4 flex justify-between items-center">
                        <button id="generate-synthesis-report-btn" class="bg-gray-800 hover:bg-gray-900 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Generiert ein pr√§gnantes, internes Memo, das den gesamten Fall (Finanzen, Risiko, Strategie) f√ºr Meetings zusammenfasst.">
                            üìë Prozessphasen-Memo (Strategische Synthese)
                        </button>
                        <span class="text-xs text-gray-500 ml-3">Kosten: 4 Credits</span>
                    </div>
                    
                    <!-- NEU: Mandat Generator Button -->
                    <div class="mb-6 border-b pb-4 flex justify-between items-center">
                        <button id="generate-negotiation-mandate-btn" class="bg-blue-900 hover:bg-blue-800 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Synthetisiert Risikobewertung, Kosten und Strategie in einem Memo, das die minimale Einigungssumme und die maximale Risikoschwelle f√ºr Verhandlungen definiert.">
                            üí∞ Verhandlungs-Mandat-Generator
                        </button>
                        <span class="text-xs text-gray-500 ml-3">Kosten: 12 Credits</span>
                    </div>

                    <!-- NEU: Gegner-Verl√§sslichkeit-Score Button -->
                    <div class="mb-6 border-b pb-4 flex justify-between items-center">
                        <button id="generate-reliability-score-btn" class="bg-red-700 hover:bg-red-800 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Bewertet die Verl√§sslichkeit und das voraussichtliche Prozessverhalten der Gegenseite (Score 1/5 bis 5/5) basierend auf dem Sachverhalt.">
                            üéØ Gegner-Verl√§sslichkeit-Score
                        </button>
                        <span class="text-xs text-gray-500 ml-3">Kosten: 8 Credits</span>
                    </div>

                    <div id="consequences-container" class="space-y-4">
                        <p class="text-gray-500">Bitte Daten laden.</p>
                    </div>
                    
                    <!-- NEU: Mandanten-Brief Generator -->
                    <h3 class="text-xl font-bold text-blue-900 mb-4 mt-8 border-t pt-4">Mandanten-Kommunikation</h3>
                    <p class="text-sm text-gray-700 mb-4">Generiert einen Briefentwurf zur Erkl√§rung der Strategie, des Kostenrisikos und zur Einholung der Freigabe.</p>
                    
                    <div class="flex space-x-3 mb-4">
                        <button id="generate-client-letter-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Generiert einen fertigen Briefentwurf, der die Strategie und die Kostenfreigabe des Mandanten einholt.">
                            ‚ú® Mandanten-Brief generieren (Kostenfreigabe)
                        </button>
                        <span class="text-xs text-gray-500 ml-3 mt-2">Kosten: 3 Credits</span>
                    </div>

                    <!-- NEU: Schriftsatz Generierung -->
                    <h3 class="text-xl font-bold text-blue-900 mb-4 mt-8 border-t pt-4">Dokumenten-Entw√ºrfe (Schrifts√§tze)</h3>
                    <p class="text-sm text-gray-700 mb-4">Generieren Sie direkt einen Entwurf f√ºr eine Strafanzeige oder ein au√üergerichtliches Mahnschreiben, basierend auf dem analysierten Fall.</p>
                    
                    <div class="flex space-x-3 mb-4">
                        <select id="draft-type-select" class="p-2 border border-gray-300 rounded-lg text-sm bg-gray-50 text-gray-900">
                            <option value="strafanzeige">Strafanzeige-Entwurf</option>
                            <option value="mahnschreiben">Au√üergerichtliches Mahnschreiben</option>
                        </select>
                        <button id="generate-draft-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Generiert einen formal korrekten Schriftsatzentwurf (Strafanzeige oder Mahnschreiben) zur direkten Verwendung.">
                            ‚ú® Schriftsatz-Entwurf generieren
                        </button>
                    </div>
                    
                    <!-- NEU: Sekretariats-Assistenz -->
                    <h3 class="text-xl font-bold text-blue-900 mb-4 mt-8 border-t pt-4">Sekretariats-Assistenz (Entw√ºrfe)</h3>
                    <p class="text-sm text-gray-700 mb-4">Generieren Sie Entw√ºrfe f√ºr Standard-Korrespondenz.</p>
                    
                    <div class="flex space-x-3 mb-4">
                        <select id="secretarial-draft-type-select" class="p-2 border border-gray-300 rounded-lg text-sm bg-gray-50 text-gray-900">
                            <!-- Vorhandene Optionen (16 St√ºck) -->
                            <option value="mandant_status_update">E-Mail: Status-Update an Mandant</option>
                            <option value="zeuge_anfrage">Anschreiben: Zeugenladung/-anfrage</option>
                            <option value="gegner_fristsetzung">Anschreiben: Fristsetzung an Gegenseite</option>
                            <option value="gegner_vergleichsangebot">Anschreiben: Unterbreitung Vergleichsangebot</option>
                            <option value="interne_notiz">Interne Notiz: Zusammenfassung f√ºr Kollege</option>
                            <option value="mandatsbestaetigung">Anschreiben: Mandatsbest√§tigung (inkl. DSGVO)</option>
                            <option value="vorschussanforderung">Anschreiben: Vorschussanforderung (nach RVG)</option>
                            <option value="fristverlaengerung">E-Mail: Fristverl√§ngerung (H√∂flich/Standard)</option>
                            <option value="akteneinsicht">Anschreiben: Akteneinsichtsgesuch (Gericht)</option>
                            <option value="fallabschluss">Interne Notiz: Fallabschluss & Archivierung</option>
                            <option value="beweissicherungsanforderung">E-Mail: Gegenseite ‚Äì Beweissicherung anfordern</option>
                            <option value="zwischenbericht_komplexitaet">Anschreiben: Mandant ‚Äì Zwischenbericht (Komplexit√§t)</option>
                            <option value="terminsverlegungsantrag">Anschreiben: Gericht ‚Äì Terminsverlegungsantrag (Begr√ºndet)</option>
                            <option value="honorar_zahlungsverzug">Anschreiben: Mandant ‚Äì Zahlungsverzug Honorar (Erinnerung)</option>
                            <option value="terminbestaetigung_checkliste">E-Mail: Mandant ‚Äì Gerichtstermin Best√§tigung (inkl. Checkliste)</option>
                            <option value="aufforderung_unterlagen">Anschreiben: Mandant ‚Äì Aufforderung fehlender Unterlagen (mit finaler Frist)</option>
                            <!-- NEUE OPTIONEN (3 weitere, alte Iteration) -->
                            <option value="antwort_gegnerischer_antrag">Schriftsatz-Entwurf: Antwort auf Klageerwiderung (Vorbereitung)</option>
                            <option value="verhandlungsstrategie_matrix">Interne Notiz: Verhandlungsstrategie & Risiko-Matrix (Entwurf)</option>
                            <option value="zeugeninterview_leitfaden">Interne Notiz: Zeugeninterview Leitfaden (Fallbezogen)</option>
                            <!-- NEUESTE OPTIONEN (3 weitere, hinzugef√ºgt) -->
                            <option value="antwort_pkh_antrag">Schriftsatz-Entwurf: Antwort auf PKH-Antrag (Vorbereitung)</option>
                            <option value="risiko_review_bericht">Interner Bericht: Strategie-Check (Risiko-Review 2.0)</option>
                            <option value="mandatsablehnung">Anschreiben: Mandant ‚Äì Mandatsablehnung/Teilabweisung</option>
                            <!-- NEUESTE OPTIONEN (3 neue) -->
                            <option value="mandanten_fuehrungs_leitfaden">Interner Bericht: Mandanten-F√ºhrungs-Leitfaden</option>
                            <option value="vorbehaltserklaerung_dritte">E-Mail: Vorbehaltserkl√§rung an Dritte (Beweis)</option>
                            <option value="zustellungsmangel_ruegen">Anschreiben: Gericht ‚Äì Zustellungsm√§ngel r√ºgen</option>
                        </select>
                        <button id="generate-secretarial-draft-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Generiert einen Entwurf f√ºr die ausgew√§hlte Sekretariatsaufgabe.">
                            ‚ú® Sekretariats-Entwurf generieren
                        </button>
                         <span class="text-xs text-gray-500 ml-3 mt-2">Kosten: 1 Credit</span>
                    </div>
                    
                    <pre id="draft-output" class="w-full h-72 p-4 border border-gray-300 rounded-lg bg-gray-50 font-mono text-sm overflow-auto whitespace-pre-wrap text-gray-900">Der generierte Entwurf wird hier angezeigt...</pre>
                </div>
            </section>
            
            <!-- 7. Aktionsplan (To-Do) -->
             <section id="tasks" class="content-area">
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-xl font-bold text-blue-900 mb-4">Aktionsplan (To-Do)</h3>
                    <p class="text-sm text-gray-700 mb-6">Verwalten Sie die n√§chsten Schritte und Fristen f√ºr diesen Fall.</p>
                    
                    <!-- NEU: KI-Button f√ºr To-Do-Generierung -->
                    <div class="mb-6 border-b pb-4 flex justify-between items-center">
                        <button id="generate-tasks-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Generiert sofort umsetzbare To-Do-Punkte aus der juristischen Strategie und importiert sie in den Plan.">
                            ‚ú® KI-To-Do generieren & importieren
                        </button>
                        <span class="text-xs text-gray-500 mt-2">Kosten: 1 Credit</span>
                    </div>

                    <!-- Task Input -->
                    <div class="flex space-x-2 mb-4 border-b pb-4">
                        <input type="text" id="task-input-text" class="flex-1 rounded-md border-gray-300 shadow-sm p-2 text-sm bg-gray-50 text-gray-900" placeholder="Neue Aufgabe eintragen...">
                        <input type="date" id="task-input-date" class="rounded-md border-gray-300 shadow-sm p-2 text-sm w-36 bg-gray-50 text-gray-900">
                        <button id="add-task-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm" title="F√ºgt eine neue manuelle Aufgabe zum Aktionsplan hinzu.">Hinzuf√ºgen</button>
                    </div>

                    <!-- Task List -->
                    <div id="task-list-container" class="space-y-3">
                        <p class="text-gray-500 text-sm">Keine Aufgaben f√ºr diesen Fall hinterlegt.</p>
                    </div>
                </div>
            </section>

            <!-- 8. KI-Dokumenten-Chat (NEUE SEKTION) -->
            <section id="ai-chat" class="content-area">
                <div class="bg-white p-6 rounded-lg shadow-md flex flex-col h-[70vh]">
                    <h3 class="text-xl font-bold text-blue-900 mb-4 border-b pb-2">KI-Dokumenten-Chat (Gemini-Analyse)</h3>
                    <p class="text-sm text-gray-700 mb-4">Fragen Sie die KI zu Falldetails oder laden Sie Dokumenten-Screenshots zur Analyse hoch. (Simuliert einen Experten-Analysten)</p>

                    <!-- Chat Verlauf -->
                    <div id="chat-history" class="chat-container flex-grow p-4 bg-gray-50 rounded-lg mb-4 space-y-3 border border-gray-200">
                        <div class="chat-message ai-message text-sm">Hallo! Ich bin dein juristischer KI-Assistent. Wie kann ich dir bei der Analyse dieses Falls helfen? Du kannst mir auch Bilder von Dokumenten zeigen.</div>
                        <!-- Chat-Nachrichten werden hier eingef√ºgt -->
                    </div>

                    <!-- Eingabe und Upload -->
                    <!-- STABILISIERUNG: Drop-Zone-Klasse f√ºr besseres Drag-and-Drop-Feedback -->
                    <div id="chat-drop-zone" class="flex flex-col space-y-2 p-3 border-2 border-gray-300 border-solid rounded-lg transition duration-200">
                        <div id="file-preview-container" class="hidden flex items-center p-2 bg-yellow-50 rounded-lg text-xs text-yellow-800 border border-yellow-200">
                            <span id="file-preview-name" class="flex-1"></span>
                            <button id="clear-file-btn" class="text-red-500 hover:text-red-700 ml-2 font-bold">‚ùå</button>
                        </div>

                        <div class="flex space-x-2 items-center">
                            <label for="ai-file-upload" class="cursor-pointer bg-blue-100 hover:bg-blue-200 text-blue-600 font-semibold py-2 px-3 rounded-lg transition duration-150 text-sm shadow-sm" title="Bild oder Dokument hochladen">
                                üìÑ Dokument/Bild ausw√§hlen
                                <input type="file" id="ai-file-upload" class="hidden" accept="image/*" />
                            </label>
                            
                            <input type="text" id="chat-input" class="flex-1 rounded-md border-gray-300 shadow-sm p-3 text-sm bg-gray-50 text-gray-900" placeholder="Frage zur Fallakte stellen oder Datei hierher ziehen...">
                            
                            <button id="send-chat-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-5 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Sendet die Frage und optional das Bild zur KI-Analyse.">Senden</button>
                            <span class="text-xs text-gray-500">Kosten: 1 Credit</span>
                        </div>
                    </div>
                    <!-- NEU: Datenschutz- und Haftungshinweis f√ºr KI-Chat -->
                    <div class="mt-4 p-3 bg-red-100 border border-red-400 rounded-lg text-xs text-red-800 font-semibold">
                        ‚ö†Ô∏è **Wichtiger Hinweis zu Datenschutz & Haftung:** Die KI verarbeitet die eingegebenen Daten und hochgeladenen Dokumente. Der Nutzer ist allein f√ºr die Einhaltung der Datenschutzbestimmungen (DSGVO) verantwortlich. Dieses Tool bietet keine Rechtsberatung, die KI-Ergebnisse dienen lediglich der Unterst√ºtzung.
                    </div>
                </div>
            </section>
            
            <!-- 9. Urteils- & Rechtssprechungsanalyse (NEUE SEKTION) -->
            <section id="judgment-analysis" class="content-area">
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h3 class="text-xl font-bold text-blue-900 mb-4">Urteils- und Rechtsprechungsanalyse</h3>
                    <p class="text-sm text-gray-700 mb-4">Analysieren Sie die Relevanz von Vergleichsurteilen f√ºr den aktuellen Fall. Geben Sie den Urteilstext (als Rohtext) in das Feld unten ein oder nutzen Sie den KI-Chat, um Bilder von Urteilen zu analysieren.</p>
                    
                    <label class="block text-sm font-medium text-gray-700 mb-2">Urteilstext zum Analysieren (Rohtext)</label>
                    <textarea id="judgment-input" class="w-full h-32 p-4 border border-gray-300 rounded-lg font-mono text-xs focus:ring-blue-500 focus:border-blue-500 bg-gray-50 text-gray-900" placeholder="[Hier den Urteilstext des Vergleichsfalls einf√ºgen, z.B. BGH Urteil X ZR 123/15...]"></textarea>
                    
                    <div class="mb-6 border-b pb-4 flex justify-between items-center mt-4">
                        <button id="analyze-judgment-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Analysiert den eingegebenen Urteilstext und bewertet dessen Relevanz f√ºr den aktuellen Fall.">
                            ‚ú® Urteil analysieren & Relevanz bewerten
                        </button>
                        <span class="text-xs text-gray-500 mt-2">Kosten: 3 Credits</span>
                    </div>

                    <!-- NEU: Aktenzeichen-Triage-Filter Button -->
                    <div class="mb-6 border-b pb-4 flex justify-between items-center mt-4">
                        <button id="generate-triage-filter-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Simuliert die Suche in einer Rechtsdatenbank und filtert die 5 relevantesten Urteile f√ºr die aktuelle Fallkonstellation.">
                            ‚ú® Aktenzeichen-Triage-Filter (Recherche)
                        </button>
                        <span class="text-xs text-gray-500 mt-2">Kosten: 8 Credits</span>
                    </div>
                    
                    <!-- NEU: Abgrenzungs-Matrix Button -->
                    <div class="mb-6 border-b pb-4 flex justify-between items-center mt-4">
                        <button id="generate-precedent-matrix-btn" class="bg-blue-800 hover:bg-blue-900 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Vergleicht analysierte Urteile mit dem aktuellen Fall und generiert eine Checkliste zur Anwendung/Abgrenzung von Pr√§zedenzf√§llen.">
                            ‚ú® Pr√§zedenzfall-Abgrenzungs-Matrix
                        </button>
                        <span class="text-xs text-gray-500 ml-3">Kosten: 9 Credits</span>
                    </div>

                    <!-- NEU: Visueller Impact Report Button -->
                    <div class="mb-6 border-b pb-4 flex justify-between items-center mt-4">
                        <button id="generate-impact-report-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Generiert einen visuellen Chart, der die eigene Forderungsh√∂he im Vergleich zur Bandbreite √§hnlicher Pr√§zedenzf√§lle darstellt.">
                            ‚ú® Visueller Urteils-Impact-Report
                        </button>
                        <span class="text-xs text-gray-500 mt-2">Kosten: 4 Credits</span>
                    </div>

                    <div class="mb-6 border-b pb-4 flex justify-between items-center mt-4">
                         <button id="export-precedent-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Erstellt einen strukturierten, kopierbaren Markdown-Bericht der analysierten Urteile f√ºr die interne Kanzlei-Wissensdatenbank.">
                            ‚ú® Urteil f√ºr Wissensdatenbank exportieren
                        </button>
                        <span class="text-xs text-gray-500 mt-2">Kosten: 1 Credit</span>
                    </div>
                    
                    <!-- Chart Container f√ºr Impact Report -->
                    <div id="impact-chart-container" class="mt-8 hidden">
                        <h4 class="text-lg font-semibold text-gray-900 mb-3">Visueller Impact Report</h4>
                        <div class="chart-container" style="max-width: 100%; height: 300px; max-height: 400px; margin: 0 auto;">
                            <canvas id="impactChart"></canvas>
                        </div>
                    </div>


                    <div id="judgment-analysis-output" class="space-y-4">
                        <p class="text-gray-500">Urteile werden hier nach Relevanz angezeigt, sobald die Analyse abgeschlossen ist.</p>
                    </div>
                </div>
            </section>
            
            <!-- 10. BRAO-Compliance (NEUE SEKTION) -->
            <section id="brao-compliance" class="content-area">
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-xl font-bold text-blue-900 mb-4">BRAO-Compliance & Berufsrecht</h3>
                    <p class="text-sm text-gray-700 mb-4">Diese Sektion dient als Erinnerung an zentrale berufsrechtliche Pflichten und bietet Werkzeuge zur Unterst√ºtzung der Compliance.</p>

                    <!-- Disclaimer -->
                    <div class="mb-6 p-4 bg-yellow-50 border border-yellow-400 rounded-lg text-sm text-yellow-800 font-semibold">
                        ‚ö†Ô∏è **Wichtiger Hinweis:** Dieses Tool ersetzt keine individuelle Pr√ºfung oder Rechtsberatung. Die Einhaltung der BRAO, insbesondere der Sorgfaltspflicht (¬ß 43 BRAO) und die Pr√ºfung auf Interessenkollisionen (¬ß 43a Abs. 4 BRAO), obliegt allein dem Nutzer. Die hier generierten Informationen sind als Unterst√ºtzung und Denkansto√ü zu verstehen.
                    </div>

                    <!-- Checkliste -->
                    <h4 class="text-lg font-bold text-gray-900 mb-3 border-t pt-4">Compliance Checkliste (Auszug)</h4>
                    <ul class="list-disc ml-5 space-y-2 text-sm text-gray-700 mb-6">
                        <li>**Verschwiegenheit (¬ß 43a Abs. 2 BRAO):** Sind alle Informationen im Rohtext und in den Notizen f√ºr die Speicherung geeignet oder entsprechend anonymisiert?</li>
                        <li>**Interessenkollision (¬ß 43a Abs. 4 BRAO):** Wurden alle beteiligten Parteien (auch potenzielle Zeugen, fr√ºhere Mandanten im Sachverhalt) identifiziert und auf m√∂gliche Kollisionen gepr√ºft?</li>
                        <li>**Sachlichkeitsgebot (¬ß 43a Abs. 3 BRAO):** Entsprechen die generierten Entw√ºrfe (z.B. Schrifts√§tze) und die Strategie dem Gebot der Sachlichkeit?</li>
                        <li>**Honorar (RVG / ¬ß 49b BRAO):** Wurde die Kostenberechnung (siehe Finanzen) gepr√ºft und ist die Honorarvereinbarung (falls abweichend vom RVG) konform?</li>
                        <li>**Aktenf√ºhrung (¬ß 50 BRAO):** Werden alle relevanten Informationen und Analyseschritte angemessen dokumentiert (z.b. durch Export/Speicherung)?</li>
                    </ul>

                     <!-- KI BRAO Report Button -->
                    <div class="mb-6 border-b pb-4 flex justify-between items-center">
                        <button id="generate-brao-report-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm shadow-md disabled:opacity-50" disabled title="Analysiert den Falltext auf Hinweise zu BRAO-relevanten Themen (z.B. genannte Parteien f√ºr Kollisionspr√ºfung, Geb√ºhrenvereinbarungen).">
                            ‚ú® KI-Analyse: BRAO-Aspekte im Falltext
                        </button>
                        <span class="text-xs text-gray-500 ml-3">Kosten: 3 Credits</span>
                    </div>

                    <!-- Output f√ºr KI Report -->
                    <h4 class="text-lg font-bold text-gray-900 mb-3 mt-4">Ergebnis der KI-Analyse (BRAO-Aspekte):</h4>
                    <pre id="brao-report-output" class="w-full h-60 p-4 border border-gray-300 rounded-lg bg-gray-50 font-mono text-xs overflow-auto whitespace-pre-wrap text-gray-900">Der generierte Bericht zu BRAO-Aspekten wird hier angezeigt...</pre>
                </div>
            </section>


        </main>
    </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy, getDocs, deleteDoc, updateDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


// --- WICHTIGE GLOBALE VARIABLEN (GANZ OBEN PLATZIERT) ---
let caseData = null;
let financialsChartInstance = null; 
let scenarioChartInstance = null; 
let impactChartInstance = null; // NEU

let rawCaseText = "";
let currentFilter = "ALL";

// NEU: Variablen f√ºr KI-Chat
let uploadedFileBase64 = null;
let uploadedFileMimeType = null;
let isAiLoading = false; // STABILISIERUNG: Flag, um Doppelsendungen zu verhindern
let isKiProcessing = false; // NEU: Globale Flagge zur Verhinderung gleichzeitiger KI-Aufrufe
let currentRequestId = null; // NEU: Globaler Tracker f√ºr die aktuelle KI-Anfrage

let db;
let auth;
let userId;
let caseCollectionRef;

// Firestore Path Constants
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

// --- KORREKTUR: Cloudflare Worker Proxy Konfiguration ---
const CLOUDFLARE_WORKER_URL = 'https://ki-proxi-juradynamics.xoomm290268.workers.dev/'; // Dein Worker-Endpunkt
const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025'; // Das verwendete Modell
const PLACEHOLDER_API_KEY = "WORKER_PROXY_IN_USE"; // Dummy-Wert, da der Key im Worker gespeichert ist
// --- ENDE KORREKTUR ---


// Systems Instructions
const chatSystemInstruction = "Du bist ein erfahrener juristischer Assistent. Analysiere die bereitgestellten Falldaten (entweder als Rohtext, Bild oder strukturierte Daten) und beantworte die Fragen des Nutzers pr√§zise, sachlich und in Deutsch. Vermeide irrelevante Details.";
const strategySystemInstruction = "Du bist ein erfahrener Prozessanwalt. Deine Aufgabe ist es, eine aggressive, dreistufige (Strafrecht, Zivilrecht/Gewerberecht, √ñffentliche Folgen) Eskalationsstrategie zu entwickeln, um den maximalen Druck auf die Gegenseite auszu√ºben. Generiere die Strategie als JSON-Array. Gib nur den JSON-Block aus;";
const tasksSystemInstruction = "Du bist ein Projektmanager. Deine Aufgabe ist es, die vom Anwalt erstellte dreistufige juristische Strategie in konkrete, sofort umsetzbare To-Do-Punkte zu zerlegen. Generiere die To-Dos als JSON-Array mit Text und einem gesch√§tzten Datum. Gib nur den JSON-Block aus;";
const judgmentSystemInstruction = "Du bist ein Richter mit Fokus auf den Sachverhalt. Analysiere den bereitgestellten Urteilstext und fasse die zentralen Fakten und die Bewertung der Relevanz f√ºr den Hauptfall pr√§zise zusammen. Gib nur ein JSON-Objekt aus.";
const financialExtractionSystemInstruction = "Du bist ein Finanzanalyst. Extrahiere NUR die Zahlenwerte (als INTEGER) f√ºr das Schmerzensgeld und den gezahlten Betrugsschaden aus dem bereitgestellten Rohtext. Gib nur ein JSON-Objekt aus.";
const draftSystemInstruction = "Du bist ein pr√§ziser, deutscher Jurist und erstellst einen Entwurf f√ºr einen Schriftsatz. Nutze die bereitgestellten Fakten (Fallname, Forderung, Beweislage, Rechtsverst√∂√üe) und den Rohtext, um einen formal korrekten Entwurf zu generieren. Ersetze Platzhalter wie Empf√§nger und Aktenzeichen durch '[...]' und generiere den Output als reinen, formatierten Text im Markdown-Format, NICHT als JSON-Objekt.";
const auditSystemInstruction = "Du bist ein Datenschutz- und Compliance-Experte. Analysiere den bereitgestellten Fallkontext und den Rohtext auf die Erfassung und Speicherung personenbezogener Daten. Erstelle einen strukturierten, internen Audit-Bericht (Markdown-Format) √ºber den Status der Datenspeicherung und m√∂gliche Risiken (DSGVO).";
const precedentExportInstruction = "Du bist ein Wissensmanager. Fasse die analysierten Urteile pr√§gnant in einem standardisierten Markdown-Format zusammen, um sie f√ºr die interne Kanzlei-Wissensdatenbank vorzubereiten. Pr√§sentiere die Fakten klar und strukturiert.";
const causalitySystemInstruction = "Du bist ein erfahrener Gutachter f√ºr Schadensersatzforderungen. Erstelle eine l√ºckenlose juristische Kausalit√§tskette (Gutachten-Stil, Markdown-Format) f√ºr die Hauptforderung (Schmerzensgeld) und beweise die direkte Ursache durch die strafrechtlichen Verst√∂√üe der Gegenseite (Vorsatz, Rechtswidrigkeit, Schuld). Nutze die Fakten und Paragraphen aus dem Kontext. Gib nur den formatierten Markdown-Text aus.";
const clientLetterSystemInstruction = "Du bist ein erfahrener Kanzleimanager. Erstelle ein formelles Schreiben an den Mandanten (Markdown-Format) mit folgenden Inhalten: 1. Eine Zusammenfassung des vorgeschlagenen Vorgehens (Strategie), 2. Eine klare und leicht verst√§ndliche Darstellung des Kostenrisikos (basierend auf den Finanzdaten), 3. Eine explizite Freigabeklausel zur Unterschrift. Das Ziel ist maximale Transparenz und die Honorarsicherung. Gib nur den formatierten Markdown-Text aus;";
const rvgSystemInstruction = "Du bist ein Experte f√ºr das Rechtsanwaltsverg√ºtungsgesetz (RVG). Basierend auf der Forderungsh√∂he und der durchgef√ºhrten Strategie (Zivil- & Strafrecht) erstellst du eine detaillierte, fehlerfreie Kostenberechnung im Gutachten-Stil. Nutze die RVG-Geb√ºhrentatbest√§nde und die korrekten Geb√ºhrens√§tze f√ºr den Mandantenwert. Gib nur den formatierten Markdown-Text aus;";
const dueDiligenceSystemInstruction = "Du bist der Anwalt der Gegenseite. Analysiere die St√§rken und Schw√§chen der vorliegenden Fallakte (Beweise, Verst√∂√üe, Rohtext). Generiere eine kritische Due-Diligence-Analyse (Markdown-Format), die die st√§rkste Verteidigungshypothese der Gegenseite aufstellt und die Schwachpunkte in der Kl√§ger-Beweiskette aufzeigt (Simulation des Gegners). Gib nur den formatierten Markdown-Text aus;";
const triageFilterSystemInstruction = "Du bist eine juristische Suchmaschine. Finde und strukturiere die 3-5 relevantesten, neuesten und am besten passenden Pr√§zedenzf√§lle (Aktenzeichen und Kurzbeschreibung) basierend auf dem Fallkontext. Generiere den Output als strukturierten Markdown-Text, der sofort kopiert und in einen Schriftsatz eingef√ºgt werden kann. Gib nur den formatierten Markdown-Text aus;";
const presentationSystemInstruction = "Du bist ein Experte f√ºr juristische Prozessf√ºhrung und Pr√§sentation. Generiere eine klare, visuell aufbereitete Pr√§sentation (Markdown-Format) des Falles. Konzentriere dich auf die Chronologie, die 3 wichtigsten Beweise und die 2 Hauptverst√∂√üe. Nutze Emojis und klare √úberschriften. Gib nur den formatierten Markdown-Text aus.";
const braoSystemInstruction = "Du bist ein Experte f√ºr die Bundesrechtsanwaltsordnung (BRAO). Analysiere den Fallkontext und Rohtext auf potenzielle Ber√ºhrungspunkte mit der BRAO (z.B. ¬ß 43, ¬ß 43a BRAO - Verschwiegenheit, Interessenkonflikte, Sachlichkeit, Geb√ºhren ¬ß 49b). Erstelle einen kurzen Bericht (Markdown-Format) mit identifizierten Aspekten und allgemeinen Hinweisen zur Pr√ºfung durch den Anwalt. Gib nur den Markdown-Text aus.";
const secretarialSystemInstruction = "Du bist ein effizienter Sekretariats-Assistent in einer Anwaltskanzlei. Erstelle basierend auf dem Fallkontext einen professionellen, h√∂flichen und fehlerfreien Entwurf f√ºr die angeforderte Korrespondenz (z.B. E-Mail, Anschreiben). Achte auf korrekte Anreden und ersetze spezifische Adressdaten oder Aktenzeichen durch Platzhalter '[...]'. Gib nur den formatierten Markdown-Text aus.";
const gapAnalysisSystemInstruction = "Du bist ein forensischer Gutachter. Analysiere die Rechtsverst√∂√üe (violations) im Fallkontext gegen die vorhandenen Beweise (evidence). Identifiziere die SCHL√úSSEL-ELEMENTE, die juristisch f√ºr die Beweisf√ºhrung noch fehlen, um die Beweiskette zu schlie√üen. Erstelle eine strukturierte Checkliste (Markdown-Format) der fehlenden Beweise (Dokumente, Zeugenaussagen, Daten) und eine kurze Begr√ºndung, warum sie strategisch notwendig sind.";
const rvgJustificationSystemInstruction = "Du bist ein erfahrener Gutachter f√ºr Honorarabrechnungen. Generiere eine juristisch fundierte, detaillierte Begr√ºndung (Markdown-Format) f√ºr die angesetzten Geb√ºhren (z.B. Erh√∂hung der Mittelgeb√ºhr nach ¬ß 14 RVG). Die Begr√ºndung muss die Komplexit√§t des Falles (Verst√∂√üe, Beweislage, Strategie) als Argumente nutzen, um den Zeitaufwand und die besondere Schwierigkeit zu rechtfertigen. Gib nur den formatierten Markdown-Text aus;";
const synthesisReportSystemInstruction = "Du bist ein erfahrener Kanzleipartner. Erstelle ein pr√§gnantes, internes 'Phase Change Memo' (Markdown) f√ºr die Mandatsleitung. Synthetisiere die gesamte Fallanalyse (Beweise, Verst√∂√üe, Strategie, Finanzen). Der Bericht muss enthalten: 1. Executive Summary (Aktueller Risikostand), 2. Finanzielle √úbersicht, 3. Status der Beweislage (L√ºcken/St√§rken), 4. Die drei n√§chsten entscheidenden Handlungsschritte (Next Steps). Gib nur den formatierten Markdown-Text aus;";
const precedentMatrixSystemInstruction = "Du bist ein erfahrener Prozessanwalt. Deine Aufgabe ist es, eine Abgrenzungs- und Anwendungsstrategie f√ºr Pr√§zedenzf√§lle zu entwickeln. Vergleiche die vorliegenden Falldaten (Fakten, Beweise) mit den bereits analysierten Urteilen im Kontext. Generiere eine strukturierte Argumentations-Matrix (Markdown-Format), die pr√§zise formuliert, wie ein Urteil 1) auf den Fall anzuwenden ist und 2) wie es gegen die gegnerische Argumentation abzugrenzen ist. Gib nur den formatierten Markdown-Text aus."; // NEU

// NEU: Dashboard System Instruction
const impactDashboardSystemInstruction = "Du bist ein Webentwickler und Daten-Visualisierer. Generiere den vollst√§ndigen HTML/CSS/JS-Code f√ºr ein interaktives Dashboard. Das Dashboard muss die wichtigsten Fallinformationen (Titel, Friststatus, Gesamtforderung) und die Ergebnisse des Beweisl√ºcken-Scanners (Checkliste der fehlenden Beweise) sowie den Risiko-Score (Deep-Due-Diligence) und die Verteilung der Rechtsverst√∂√üe (Violations) grafisch ansprechend darstellen. Verwende Tailwind CSS (√ºber CDN) und Chart.js. Der Output muss nur den Code als reinen Text zur√ºckgeben.";

// NEU: Template Extractor System Instruction
const templateExtractorSystemInstruction = "Du bist ein Wissensmanager und Anonymisierungsexperte. Deine Aufgabe ist es, den bereitgestellten Rohtext und den Fallkontext zu analysieren und eine generische, wiederverwendbare Mandatsvorlage (Markdown-Format) daraus zu erstellen. Entferne alle mandantenspezifischen und vertraulichen Informationen (Namen, Adressen, Summen, Aktenzeichen, spezifische Daten) und ersetze diese durch klare Platzhalter wie `[NAME_MANDANT]`, `[KLAGESUMME]` oder `[AKTENZEICHEN_GERICHT]`. Der Output ist eine bereinigte, formalisierte Vorlage f√ºr das interne Wissensmanagement. Gib nur den formatierten Markdown-Text aus.";

// NEU: Gegner-Verl√§sslichkeit-Score System Instruction
const opponentReliabilitySystemInstruction = "Du bist ein Prozessstratege und Risikomanager. Analysiere den Sachverhalt, die Chronologie und die Rechtsverst√∂√üe im Fallkontext. Bewerte die voraussichtliche 'Verl√§sslichkeit' des Gegners auf einer Skala von 1 (Sehr zuverl√§ssig, verhandlungsbereit) bis 5 (Extrem unzuverl√§ssig, Prozessverz√∂gerung wahrscheinlich). Generiere einen internen Bericht (Markdown-Format), der den Score begr√ºndet, die Wahrscheinlichkeit f√ºr eine schnelle Einigung prognostiziert und die erwartete Prozessdauer sch√§tzt. Gib nur den formatierten Markdown-Text aus."; // NEU

// NEU: Verhandlungs-Mandat-Generator System Instruction
const negotiationMandateSystemInstruction = "Du bist der f√ºhrende Verhandlungsstratege. Synthetisiere die Risikoanalyse (Due Diligence, Gegner-Score), die Kausalit√§tskette (Gutachten) und die Finanzdaten. Definiere klar und pr√§zise die juristisch vertretbare Verhandlungsbandbreite. Generiere ein internes, vertrauliches Memo (Markdown-Format) mit: 1. Dem klaren MINIMUM-Einigungsziel (Euro), 2. Der MAXIMALEN Risikoschwelle (Euro, wann ist ein Prozess wirtschaftlich besser), 3. Den 3 wichtigsten psychologischen/juristischen Hebeln, die in der Verhandlung eingesetzt werden m√ºssen. Gib nur den formatierten Markdown-Text aus."; // NEU

// NEU: Dynamischer Eskalations-W√§chter System Instruction (KORRIGIERT)
const escalationWatcherSystemInstruction = "Du bist ein Strategischer Prozessmanager. Analysiere den Fallkontext (Chronologie, Finanzen, Verst√∂√üe, Strategie) und bewerte das aktuelle Eskalationsrisiko. Erstelle einen strukturierten Bericht (Markdown), der einen neu bewerteten, dynamischen Zeitstrahl mit den n√§chsten 3 Handlungsschritten und dem erforderlichen 'Strategischen Drucklevel' (Niedrig, Mittel, Hoch, Kritisch) f√ºr jeden Schritt enth√§lt. Gib nur den formatierten Markdown-Text aus."; // KORRIGIERT

// NEU: Visueller Aktenstruktur-Mapper System Instruction
const actorMapperSystemInstruction = "Du bist ein Daten-Visualisierer. Analysiere den Rohtext und den Fallkontext, um alle beteiligten Entit√§ten (Personen, Firmen, Gerichte, Zeugen) und ihre expliziten/impliziten Beziehungen (z.B. 'ist Gesch√§ftsf√ºhrer von', 'ist Zeuge f√ºr', 'droht') zu identifizieren. Generiere den vollst√§ndigen HTML-Code f√ºr eine interaktive Visualisierung dieser Akteure als Netzwerkdiagramm. Verwende eine einfache JavaScript-Graph-Bibliothek (simuliert) oder SVG/CSS f√ºr die Darstellung der Knoten und Kanten. Der Output muss nur den HTML-Code zur√ºckgeben."; // NEU

// NEU: System Instructions f√ºr Analyse-Automatisierung
const violationsSystemInstruction = "Du bist ein Experte f√ºr deutsches Straf- und Zivilrecht. Analysiere den Sachverhalt im Rohtext. Extrahiere alle relevanten Paragraphen (StGB, BGB, etc.) und fasse die Begr√ºndung basierend auf dem Sachverhalt kurz zusammen. Gib nur ein JSON-Array aus;";
const evidenceSystemInstruction = "Du bist ein forensischer Analyst. Extrahiere die 3-5 st√§rksten, beweisrelevanten Zitate (Snippets, max. 5 W√∂rter Key, max. 2 S√§tze Detail) direkt aus dem Rohtext. Ordne sie nach Schwere (HIGH/MEDIUM/LOW). Gib nur ein JSON-Array aus;";


// --- Demo Data (Schroeter Case) ---
const demoData = {
    caseName: "Schroeter vs. Spickermann KFZ GmbH",
    caseSubtitle: "Interaktive Analyse des Forderungsschreibens vom 22. September 2025.",
    financials: {
        schmerzensgeld: 2500,
        originalForderung: 178,
        bezahlterBetrug: 47,
        anwaltskostenSchaetzung: 2000, // NEU: Gesch√§tzte Anwaltskosten f√ºr die Charts
        frist: "15.10.2025" // Korrigiert f√ºr korrekte Datum-Verarbeitung
    },
    timeline: [
        { date: "04.09.2025", title: "M√ºndliche, kostenlose Vereinbarung", detail: "Mit Gesch√§ftsf√ºhrer Ljesnjanin vereinbart. Zeuge: Iwan Brus." },
        { date: "12.09.2025 (Fr√ºhe)", title: "Unrechtm√§√üige Geldforderung (178‚Ç¨)", detail: "Mitarbeiter fordert 178‚Ç¨ Diagnosegeb√ºhr entgegen der Abmachung (Versuchter Betrug)." },
        { date: "12.09.2025 (Vor Ort)", title: "Zahlung unter Vorbehalt abgelehnt", detail: "Mitarbeiter verweigert die rechtlich korrekte Zahlung unter Vorbehalt und lehnt Kooperation ab ('Ich unterschreibe gar nichts')." },
        { date: "12.09.2025 (Abend)", title: "Leugnung und Beleidigung", detail: "Gesch√§ftsf√ºhrer Ljesnjanin leugnet Abmachung. Mitarbeiter unterstellt 'Masche' ('logisch, das sieht doch jeder'). Vollendeter Betrug (47‚Ç¨)." },
        { date: "20.09.2025", title: "Frist Entschuldigung ignoriert", detail: "Die erste Frist zur Stellungnahme und Entschuldigung verstreicht fruchtlos." },
        { date: "15.10.2025", title: "Frist Schmerzensgeld ignoriert", detail: "Die finale Frist zur Zahlung der 2.500‚Ç¨ Schmerzensgeld verstreicht fruchtlos (Heute ist der 16.10.2025)." }
    ],
    evidence: [
        { type: "Zeuge/Beweismittel", title: "Eidesstattliche Versicherung", icon: "üìÑ", detail: "Best√§tigt die m√ºndliche, kostenlose Vereinbarung. **H√∂chstes Beweisgewicht**.", keyword: "eidesstattliche Versicherung", strength: "HIGH" },
        { type: "Aussage/Indiz", title: "Mitarbeiter best√§tigt 'Masche'", icon: "üó£Ô∏è", detail: "Aussage: 'Masche abziehen'. Ehrverletzende Tatsachenbehauptung. Vor Zeugen gefallen.", keyword: "Masche", strength: "MEDIUM" },
        { type: "Zeuge/Beweismittel", title: "Zweiter, unabh√§ngiger Zeuge", icon: "üë•", detail: "Best√§tigt die strafrechtlich relevanten Beleidigungen des Mitarbeiters.", keyword: "zweiter, unabh√§ngiger Zeuge", strength: "MEDIUM" },
        { type: "Aussage/Indiz", title: "Mitarbeiter best√§tigt 'System'", icon: "üìà", detail: "Aussage: 'alle Kunden sofort den Betrag bezahlen'. Indiz f√ºr gewerbsm√§√üigen Betrug.", keyword: "g√§ngige Vorgehensweise", strength: "HIGH" },
        { type: "Aussage/Indiz", title: "Teilschuldeingest√§ndnis GF", icon: "‚ùå", detail: "Reduzierung der Rechnung von 178‚Ç¨ auf 47‚Ç¨ ohne Begr√ºndung. Implizites Eingest√§ndnis der Unrechtm√§√üigkeit.", keyword: "Reduzierung der Rechnung", strength: "LOW" }
    ],
    violations: [
        { target: "Mitarbeiter / GF Ljesnjanin", code: "¬ß¬ß 185, 186, 187 StGB", title: "Ehrverletzungsdelikte", detail: "Die Unterstellung, eine 'Masche' abzuziehen, ist eine schwerwiegende Verletzung meines allgemeinen Pers√∂nlichkeitsrechts. Er hat eindeutig unterstellt, ich w√ºrde versuchen, Ihre Werkstatt zu betr√ºgen. Beide sind verantwortlich." },
        { target: "Mitarbeiter / GF Ljesnjanin", code: "¬ß 263 StGB (Betrug)", title: "Vollendeter Betrug und Systematik", detail: "Durch die Zahlung der 47‚Ç¨ f√ºr eine kostenlose Leistung ist ein Verm√∂gensschaden entstanden (vollendeter Betrug). Die Aussage zur 'g√§ngigen Vorgehensweise' deutet auf gewerbsm√§√üigen Betrug hin." }
    ],
    consequences: [
        { target: "Strafrecht", steps: ["Strafanzeige & Strafantrag (Beleidigung, Betrug)", "Ermittlungsverfahren der StA Hannover", "Pr√ºfung auf gewerbsm√§√üigem Betrug (h√∂heres Strafma√ü)"] },
        { target: "Zivil- & Gewerberecht", steps: ["Zivilklage auf 2.500‚Ç¨ Schmerzensgeld plus Prozesskosten", "Schlichtungsverfahren Kfz-Schiedsstelle (R√ºckforderung 47‚Ç¨)", "Disziplinarverfahren HWK (Pr√ºfung der Betriebserlaubnis)"] },
        { target: "√ñffentliche Folgen", steps: ["√ñffentliche Warnung durch die Verbraucherzentrale", "Umfassende Darstellung des Urteils auf Google, Facebook etc.", "Dauerhafter Rufschaden und Vertrauensverlust"] }
    ],
    judgments: [], // NEU: Array f√ºr Urteilsanalyse
    notes: {
        overview: "Der Fall basiert auf einer klaren Beweislage (zwei Zeugen, davon einer mit eidesstattlicher Versicherung). Strategie: Konzentration auf den gewerbsm√§√üigen Betrug (¬ß 263 StGB), um maximalen Druck zu erzeugen.",
        // Hier k√∂nnten Notizen f√ºr andere Sektionen folgen
    },
    tasks: [
        { text: "Strafanzeige und Strafantrag bei StA Hannover einreichen", date: "2025-10-16", done: true },
        { text: "Anschreiben an HWK und VZ versenden", date: "2025-10-16", done: true },
        { text: "Zivilklage vorbereiten (Anwalt kontaktieren)", date: "2025-10-25", done: false },
        { text: "Eidesstattliche Versicherung von Iwan Brus digitalisieren und sichern", date: "2025-10-20", done: false }
    ]
};

const demoRawText = `Sehr geehrter Herr Besim Ljesnjanin,
ich beziehe mich auf mein Schreiben vom 12.09.2025. Auf Vertrauensbasis erfolgte unsere m√ºndliche Vereinbarung vom 04.09.2025 zur kostenfreien Begutachtung. Unser Bekannter, Herr Iwan Brus war bei dieser Absprache anwesend und kann dies mit einer eidesstattliche Versicherung best√§tigen. Die Eskalation begann, als Ihr Mitarbeiter eine unberechtigte Forderung stellte.
Seine wiederholte und hartn√§ckige Unterstellung, ich w√ºrde eine "Masche" abziehen, ist eine schwerwiegende Verletzung meines allgemeinen Pers√∂nlichkeitsrechts. Er hat eindeutig unterstellt, ich w√ºrde versuchen, Ihre Werkstatt zu betr√ºgen.
Ihr Mitarbeiter best√§tigte die systematisch unlautere Gesch√§ftspraxis mit den unmissverst√§ndlichen √Ñu√üerungen, dass bei Ihnen "alle Kunden sofort den Betrag bezahlen" und es "doch logisch" sei, dass "Kosten entstehen", wenn das Auto abgegeben wird. Dies belegt die g√§ngige Vorgehensweise.
Zudem leugneten Sie, Herr Ljesnjanin, die urspr√ºngliche Abmachung.
Ich fordere hiermit eine Zahlung von Schmerzensgeld in H√∂he von 2.500,00 Euro.`;


// --- Firebase Initialization and Auth ---

async function initializeFirebase() {
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        // NEU: Worker Initialisierung hier aufrufen, um ReferenceError zu vermeiden
        initializeWorker();

        // Authentifizierung
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                caseCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/legal_cases`);
                getElement('user-status').textContent = `Nutzer-ID: ${userId}`;
                getElement('save-case-btn').disabled = false;
                // Aktiviere KI-Buttons, sobald Auth/Data da ist
                toggleKiButtons(true);
                loadCaseList(); // L√§dt sofort die F√§lle des Nutzers
            } else {
                userId = crypto.randomUUID(); // Fallback f√ºr anonyme Nutzer
                getElement('user-status').textContent = 'Anonyme Sitzung';
                getElement('save-case-btn').disabled = true;
                // Deaktiviere alle KI-Buttons
                toggleKiButtons(false);
            }
        });

    } catch (error) {
        console.error("Firebase Init/Auth Error:", error);
        getElement('user-status').textContent = 'Fehler bei der Initialisierung.';
    }
}

// --- KI-Generierungsfunktionen (NEU) ---

// NEU: Zentrale Funktion zum Aktivieren/Deaktivieren aller KI-Buttons
function toggleKiButtons(enable) {
    // Liste aller Buttons, die KI-Funktionen ausl√∂sen
    const allKiButtons = document.querySelectorAll(
        'button[id^="generate-"], button[id^="analyze-"], button[id^="extract-"], #analyze-data-btn'
    );
    allKiButtons.forEach(btn => {
        // Sperre den Button nur, wenn er aktiviert werden soll UND die globale KI-Verarbeitung NICHT l√§uft
        btn.disabled = !enable || isKiProcessing;
    });

    // Chat Senden Button muss separat betrachtet werden, da er auch von uploadedFileBase64 abh√§ngt
    const sendChatBtn = document.getElementById('send-chat-btn');
    const chatInput = document.getElementById('chat-input');
    if (sendChatBtn) {
        // KORREKTUR: Die Bedingung muss sein: Deaktiviere wenn NICHT enabled ODER isKiProcessing ODER (kein Prompt UND kein File)
        const isDisabledByContent = (chatInput?.value.trim() === '' && !uploadedFileBase64);
        sendChatBtn.disabled = !enable || isKiProcessing || isDisabledByContent;
    }
    
    // NEU: Abbrechen-Button umschalten
    const abortBtn = document.getElementById('abort-ki-btn');
    if (abortBtn) {
        if (isKiProcessing) {
            abortBtn.classList.remove('hidden');
        } else {
            abortBtn.classList.add('hidden');
        }
    }
}


function getApiKey() {
    // Gibt den aktuellen Key aus dem Input-Feld zur√ºck (ist nun obsolet, aber f√ºr die UI-Logik beibehalten)
    return getElement('input-api-key').value.trim();
}

function getCaseContext() {
    if (!caseData) return "Keine Falldaten geladen.";
    
    // KORREKTUR: Abgesicherte Zugriffe (Optional Chaining)
    const anwaltskosten = caseData.financials?.anwaltskostenSchaetzung || 2000;
    const trialRisk = anwaltskosten + (caseData.financials?.schmerzensgeld || 0);
    
    const financialSummary = `Forderung: ${caseData.financials?.schmerzensgeld || 0}‚Ç¨, Schaden: ${caseData.financials?.bezahlterBetrug || 0}‚Ç¨, Gesch√§tztes Prozessrisiko (Maximalforderung + Kosten): ${trialRisk}‚Ç¨, Frist: ${caseData.financials?.frist || 'N.A.'}.`;
    
    // KORREKTUR: Leere Arrays absichern
    const evidenceSummary = (caseData.evidence || []).map(e => `[Beweis - ${e.strength}] ${e.title}: ${e.detail}`).join('; ');
    const violationSummary = (caseData.violations || []).map(v => `${v.code} (${v.title}): ${v.detail}`).join('; ');
    const judgmentSummary = (caseData.judgments || []).map(j => `[Urteil] ${j.title}: Relevanz ${j.relevance}`).join('; ');
    const strategySummary = JSON.stringify(caseData.consequences || []);

    return `Fallname: ${caseData.caseName || 'Unbenannt'}. ${financialSummary} Strategie: ${strategySummary}. Beweislage (Aktuell): ${evidenceSummary}. Rechtsverst√∂√üe (Aktuell): ${violationSummary}. Analysierte Urteile: ${judgmentSummary}. Rohtext: ${rawCaseText}`;
}

// Funktion, die den Worker-API-Aufruf abwickelt
async function handleAIGeneration(type) {
    if (isKiProcessing) {
        showStatus("Warten Sie bitte, eine KI-Analyse l√§uft bereits.", true);
        return;
    }

    if (!caseData && type !== 'financial_extraction' && type !== 'date_extraction' && type !== 'template_extractor') {
        showStatus("Bitte laden oder analysieren Sie zuerst einen Fall.", true);
        return;
    }

    const apiKeyInput = getApiKey();
    // Der API Key wird NICHT zum Worker gesendet, aber wir pr√ºfen auf den Platzhalter f√ºr die UI-Warnung.
    if (apiKeyInput === '' || apiKeyInput === "AIzaSyC38nnuVefWRyDjiTav6E6AeXjeyBHZdEo") {
        showStatus("WARNUNG: API Key ist entweder leer oder der Google-Platzhalter. Wenn dein Worker den Key nicht enth√§lt, schl√§gt der Aufruf fehl.", true);
        // Wir lassen den Aufruf trotzdem durch den Worker laufen, da der Key dort gespeichert sein sollte.
    }
    
    // Globale Sperre aktivieren
    isKiProcessing = true;
    toggleKiButtons(false);
    
    let prompt;
    let systemInstruction;
    let loadingOverlayId = 'strategy-loading-overlay'; // Standard-Overlay
    let statusElementId = 'status-message'; // Standard-Status-Element
    let generationConfig = {};

    const context = getCaseContext();
    const rawTextOnly = `Rohtext: ${rawCaseText}`; // Spezieller Kontext f√ºr reine Rohtext-Analyse
    
    // Aktuell wird der Originaltext verwendet:
    const contextToSend = context;
    const rawTextToSend = rawTextOnly;


    if (type === 'financial_extraction') {
        const caseName = getElement('input-caseName').value.trim();
        const frist = getElement('input-frist').value.trim();
        
        if (!caseName) {
            showStatus("Bitte Falltitel eingeben.", true);
            isKiProcessing = false; toggleKiButtons(true); return; // FR√úHZEITIGES ENDE
        }
          if (!rawCaseText) {
            showStatus("Bitte Rohtext einf√ºgen, bevor Sie Finanzdaten extrahieren.", true);
            isKiProcessing = false; toggleKiButtons(true); return; // FR√úHZEITIGES ENDE
        }

        prompt = `Extrahiere aus dem Rohtext NUR die Werte (als INTEGER) f√ºr das geforderte Schmerzensgeld und den bereits gezahlten Betrugsschaden. ${rawTextToSend}`;
        systemInstruction = financialExtractionSystemInstruction;
        statusElementId = 'status-message';
        generationConfig = {
             responseMimeType: "application/json",
             responseSchema: {
                type: "OBJECT",
                properties: {
                    "schmerzensgeld": { "type": "INTEGER", "description": "Geforderter Betrag f√ºr Schmerzensgeld." },
                    "bezahlterBetrug": { "type": "INTEGER", "description": "Bereits gezahlter Betrag (Schaden/Betrug)." }
                },
                required: ["schmerzensgeld", "bezahlterBetrug"]
            }
        };

    } else if (type === 'template_extractor') { // NEU: Best-Practice-Template-Extraktor
        if (!rawCaseText) {
            showStatus("Bitte Rohtext einf√ºgen, um eine Vorlage daraus zu extrahieren.", true);
            isKiProcessing = false; toggleKiButtons(true); return; // FR√úHZEITIGES ENDE
        }
        // Der gesamte Rohtext und Kontext wird zur Entfernung sensibler Daten verwendet
        prompt = `Analysiere den folgenden Rohtext und den Fallkontext. Erstelle eine generische, wiederverwendbare Markdown-Vorlage, indem du alle spezifischen Mandanten-, Gegner-, Adress- und Summen-Daten durch Platzhalter ersetzt. Beispiel: Max Mustermann -> [NAME_MANDANT]. Gib nur den formatierten Markdown-Text aus. Kontext: ${contextToSend}. Rohtext: ${rawCaseText}`;
        systemInstruction = templateExtractorSystemInstruction;
        loadingOverlayId = 'data-input'; 
        statusElementId = 'status-message'; 
        generationConfig = {};

    } else if (type === 'draft') { // NEU: Schriftsatz-Entwurf
        const draftType = getElement('draft-type-select').value;
        const draftTitle = draftType === 'strafanzeige' ? 'Strafanzeige wegen Betrug und Beleidigung' : 'Au√üergerichtliches Mahnschreiben';
        prompt = `Erstelle einen formal korrekten Entwurf f√ºr ein Dokument vom Typ "${draftTitle}". Nutze den folgenden Fallkontext:\n\n${contextToSend}`;
        systemInstruction = draftSystemInstruction;
        loadingOverlayId = 'strategy-loading-overlay'; 
        statusElementId = 'draft-output'; 
        // WICHTIG: Keine JSON-Antwort erwartet, nur formatierten Text
        generationConfig = {};

    } else if (type === 'client_letter') { // NEU: Mandanten-Brief Generator
        // Hier pr√ºfen wir, ob die Strategie bereits generiert wurde
         if (!caseData.consequences || caseData.consequences.length === 0) {
            showStatus("Bitte zuerst die Strategie generieren ('KI-Aktionsplan erstellen').", true);
            isKiProcessing = false; toggleKiButtons(true); return; // FR√úHZEITIGES ENDE
        }
        prompt = `Erstelle einen formalen Brief an den Mandanten. Nutze den folgenden Fallkontext:\n\n${contextToSend}`;
        systemInstruction = clientLetterSystemInstruction;
        loadingOverlayId = 'strategy-loading-overlay'; 
        statusElementId = 'draft-output'; 
        // WICHTIG: Keine JSON-Antwort erwartet, nur formatierten Text
        generationConfig = {};

    } else if (type === 'rvg_calculator') { // NEU: RVG Kosten W√§chter
         if (!caseData.financials) {
            showStatus("Bitte zuerst Finanzdaten eingeben oder Gesamtanalyse starten.", true);
            isKiProcessing = false; toggleKiButtons(true); return; // FR√úHZEITIGES ENDE
        }
        // KORREKTUR: Abgesicherte Zugriffe
        prompt = `Erstelle eine detaillierte RVG-Kostenberechnung. Der Streitwert betr√§gt ${caseData.financials?.schmerzensgeld || 0}‚Ç¨ (Schmerzensgeld) plus ${caseData.financials?.bezahlterBetrug || 0}‚Ç¨ (Betrugsschaden), total ${(caseData.financials?.schmerzensgeld || 0) + (caseData.financials?.bezahlterBetrug || 0)}‚Ç¨. Die Strategie umfasst Zivil- und Strafrecht (siehe Kontext). Liste die relevanten Geb√ºhrentatbest√§nde (z.B. Gesch√§ftsgeb√ºhr, Verfahrensgeb√ºhr, Einigungsgeb√ºhr, Auslagenpauschale) mit ihren genauen S√§tzen auf. Gib nur den formatierten Markdown-Text aus. Kontext:\n\n${contextToSend}`;
        systemInstruction = rvgSystemInstruction;
        loadingOverlayId = 'overview'; 
        statusElementId = 'status-message';
        generationConfig = {};
        
    } else if (type === 'rvg_justification') { // NEU: RVG Justifizierer
         if (!caseData.financials || !caseData.violations || !caseData.evidence) {
            showStatus("Bitte zuerst Finanzdaten, Verst√∂√üe und Beweise extrahieren (Gesamtanalyse starten).", true);
            isKiProcessing = false; toggleKiButtons(true); return; // FR√úHZEITIGES ENDE
        }
        prompt = `Erstelle eine juristisch fundierte Begr√ºndung f√ºr die H√∂he der Anwaltsgeb√ºhren. Nutze die Fakten: Fallkomplexit√§t (Anzahl der Verst√∂√üe), Schwierigkeit der Beweisf√ºhrung, hoher Zeitaufwand (durch Due Diligence/Strategieentwicklung) und das Prozessrisiko. Begr√ºnde die √úberschreitung der Mittelgeb√ºhr. Fallkontext:\n\n${contextToSend}`;
        systemInstruction = rvgJustificationSystemInstruction;
        loadingOverlayId = 'overview'; 
        statusElementId = 'status-message';
        generationConfig = {};

    } else if (type === 'due_diligence') { // NEU: Deep-Due-Diligence-Scanner
        if (!caseData.evidence || caseData.evidence.length === 0) {
            showStatus("Bitte zuerst Beweise extrahieren (Gesamtanalyse starten).", true);
            isKiProcessing = false; toggleKiButtons(true); return; // FR√úHZEITIGES ENDE
        }
        prompt = `F√ºhre eine Due-Diligence-Pr√ºfung der folgenden Fallakte aus der Perspektive der Gegenseite durch. Identifiziere die st√§rksten Verteidigungshypothesen und die Schwachpunkte in der eigenen Beweiskette des Kl√§gers. Gib nur den formatierten Markdown-Text aus. Fallkontext:\n\n${contextToSend}`;
        systemInstruction = dueDiligenceSystemInstruction;
        loadingOverlayId = 'evidence-container'; 
        statusElementId = 'evidence-container';
        generationConfig = {};


    } else if (type === 'audit') { // NEU: DSGVO-Audit-Report
        prompt = `Erstelle einen internen DSGVO-Audit-Bericht f√ºr den folgenden Fall. Beurteile das Risiko der Speicherung des Rohtextes und der Daten-Compliance. Gib nur den formatierten Markdown-Text aus. Fallkontext:\n\n${contextToSend}`;
        systemInstruction = auditSystemInstruction;
        loadingOverlayId = 'data-input'; 
        statusElementId = 'status-message'; 
        generationConfig = {};

    } else if (type === 'precedent_export') { // NEU: Pr√§zedenzfall-Export
         if (!caseData.judgments || caseData.judgments.length === 0) {
            showStatus("Bitte analysieren Sie zuerst Urteile in der Urteilsanalyse-Sektion.", true);
            isKiProcessing = false; toggleKiButtons(true); return; // FR√úHZEITIGES ENDE
        }
        const judgmentsToExport = JSON.stringify(caseData.judgments);
        prompt = `Wandle die folgenden analysierten Urteile in ein strukturiertes Markdown-Format f√ºr eine Wissensdatenbank um. Gebe nur den Markdown-Text aus:\n\n${judgmentsToExport}`;
        systemInstruction = precedentExportInstruction;
        loadingOverlayId = 'judgment-analysis-output'; 
        statusElementId = 'judgment-analysis-output';
        generationConfig = {};

    } else if (type === 'causality') { // NEU: Kausalit√§ts-Maximierer
         if (!caseData.violations || caseData.violations.length === 0) {
            showStatus("Bitte zuerst Rechtsverst√∂√üe identifizieren (Gesamtanalyse starten).", true);
            isKiProcessing = false; toggleKiButtons(true); return; // FR√úHZEITIGES ENDE
        }
        prompt = `Erstelle eine l√ºckenlose juristische Kausalit√§tskette f√ºr die Schmerzensgeldforderung. Nutze den Fallkontext und die analysierten Verst√∂√üe, um die Kette logisch und gutachterlich zu untermauern. Gib nur den formatierten Markdown-Text aus. Fallkontext:\n\n${contextToSend}`;
        systemInstruction = causalitySystemInstruction;
        loadingOverlayId = 'evidence-container'; 
        statusElementId = 'evidence-container';
        generationConfig = {};
    
    } else if (type === 'triage_filter') { // NEU: Aktenzeichen-Triage-Filter
         if (!caseData.violations || caseData.violations.length === 0) {
            showStatus("Bitte zuerst Rechtsverst√∂√üe identifizieren (Gesamtanalyse starten).", true);
            isKiProcessing = false; toggleKiButtons(true); return; // FR√úHZEITIGES ENDE
        }
        prompt = `Finde die 5 relevantesten Aktenzeichen und eine Kurzbeschreibung dazu, die den folgenden Fallkontext untermauern (Simuliere die Datenbanksuche in Deutschland). Gib nur den formatierten Markdown-Text aus. Fallkontext:\n\n${contextToSend}`;
        systemInstruction = triageFilterSystemInstruction;
        loadingOverlayId = 'judgment-analysis-output'; 
        statusElementId = 'judgment-analysis-output';
        generationConfig = {};

    } else if (type === 'precedent_matrix') { // NEU: Pr√§zedenzfall-Abgrenzungs-Matrix
         if (!caseData.judgments || caseData.judgments.length === 0) {
            showStatus("Bitte analysieren Sie zuerst Urteile, die in die Matrix aufgenommen werden sollen.", true);
            isKiProcessing = false; toggleKiButtons(true); return; // FR√úHZEITIGES ENDE
        }
        prompt = `Generiere eine Abgrenzungs- und Anwendungsstrategie. Vergleiche die analysierten Urteile (siehe Kontext) mit dem aktuellen Fall. Erstelle eine strukturierte Argumentations-Matrix (Markdown), die zeigt, wie die Urteile f√ºr die eigene Klage strategisch zu nutzen und vom Gegner abzugrenzen sind. Gib nur den formatierten Markdown-Text aus. Fallkontext:\n\n${contextToSend}`;
        systemInstruction = precedentMatrixSystemInstruction;
        loadingOverlayId = 'judgment-analysis-output'; 
        statusElementId = 'judgment-analysis-output';
        generationConfig = {};
        
    } else if (type === 'presentation') { // NEU: Pr√§sentations-Generator
         if (!caseData.timeline || caseData.timeline.length === 0) {
            showStatus("Bitte zuerst eine Chronologie definieren (Demo laden).", true);
            isKiProcessing = false; toggleKiButtons(true); return; // FR√úHZEITIGES ENDE
        }
        prompt = `Erstelle eine Pr√§sentation des Falls. Nutze die Chronologie, Beweise und Verst√∂√üe aus dem Fallkontext. Gib nur den formatierten Markdown-Text aus. Fallkontext:\n\n${contextToSend}`;
        systemInstruction = presentationSystemInstruction;
        loadingOverlayId = 'timeline'; 
        statusElementId = 'status-message';
        generationConfig = {};

    } else if (type === 'synthesis_report') { // NEU: Strategische Synthese
         if (!caseData.consequences || caseData.consequences.length === 0) {
            showStatus("Bitte zuerst die Strategie generieren ('KI-Aktionsplan erstellen').", true);
            isKiProcessing = false; toggleKiButtons(true); return; // FR√úHZEITIGES ENDE
        }
        prompt = `Erstelle ein internes strategisches Phasen-Memo. Synthetisiere alle vorhandenen Fallinformationen (Strategie, Beweise, Risiko, Finanzen) und gib die wichtigsten n√§chsten Schritte aus. Gib nur den formatierten Markdown-Text aus. Fallkontext:\n\n${contextToSend}`;
        systemInstruction = synthesisReportSystemInstruction;
        loadingOverlayId = 'strategy-loading-overlay'; 
        statusElementId = 'draft-output'; 
        generationConfig = {};

    } else if (type === 'reliability_score') { // NEU: Gegner-Verl√§sslichkeit-Score
        if (!caseData.violations || !caseData.timeline) {
            showStatus("Bitte Chronologie und Verst√∂√üe extrahieren (Gesamtanalyse starten).", true);
            isKiProcessing = false; toggleKiButtons(true); return; // FR√úHZEITIGES ENDE
        }
        prompt = `Bewerte die Verl√§sslichkeit des Gegners (Score 1/5 bis 5/5) basierend auf dem Sachverhalt (Leugnung, unberechtigte Forderungen) und der Chronologie (ignorierte Fristen). Generiere einen internen Bericht. Gib nur den formatierten Markdown-Text aus. Fallkontext:\n\n${contextToSend}`;
        systemInstruction = opponentReliabilitySystemInstruction;
        loadingOverlayId = 'strategy-loading-overlay'; 
        statusElementId = 'draft-output';
        generationConfig = {};

    } else if (type === 'negotiation_mandate') { // NEU: Verhandlungs-Mandat-Generator
        if (!caseData.financials || !caseData.consequences || !caseData.evidence) {
            showStatus("Bitte Finanzdaten, Strategie und Beweise extrahieren (Gesamtanalyse starten).", true);
            isKiProcessing = false; toggleKiButtons(true); return; // FR√úHZEITIGES ENDE
        }
        prompt = `Definiere die juristisch vertretbare Verhandlungsbandbreite (Minimalziel und maximale Risikoschwelle). Erstelle ein vertrauliches Memo mit den wichtigsten psychologischen/juristischen Hebeln, die in der Verhandlung eingesetzt werden sollen. Gib nur den formatierten Markdown-Text aus. Fallkontext:\n\n${contextToSend}`;
        systemInstruction = negotiationMandateSystemInstruction;
        loadingOverlayId = 'strategy-loading-overlay'; 
        statusElementId = 'draft-output';
        generationConfig = {};

    // NEU: BRAO Report
    } else if (type === 'brao_report') {
        prompt = `Analysiere den folgenden Fallkontext und Rohtext auf m√∂gliche BRAO-Ber√ºhrungspunkte:\n\n${contextToSend}`; // Anonymisierter Kontext
        systemInstruction = braoSystemInstruction;
        loadingOverlayId = 'brao-compliance'; // Verwende die Section ID
        statusElementId = 'brao-report-output'; // Output in die <pre>
        generationConfig = {}; // Reiner Text-Output erwartet

    // NEU: Sekretariatsentwurf
    } else if (type === 'secretarial_draft') {
        const draftTypeSelect = getElement('secretarial-draft-type-select');
        const draftValue = draftTypeSelect.value;
        const draftDescription = draftTypeSelect.selectedOptions[0].text; // Holt den angezeigten Text
        
        prompt = `Erstelle einen Entwurf f√ºr das Anschreiben/die E-Mail: "${draftDescription}" (interner Code: ${draftValue}). Nutze den folgenden Fallkontext, um den Entwurf pr√§zise und adressatengerecht zu generieren. Gib nur den formatierten Markdown-Text aus. Fallkontext:\n\n${contextToSend}`;
        systemInstruction = secretarialSystemInstruction;
        loadingOverlayId = 'strategy-loading-overlay'; // Nutze das bestehende Overlay in der Sektion
        statusElementId = 'draft-output'; // Zeige Output im bestehenden <pre>
        generationConfig = {}; // Reiner Text-Output erwartet

    } else if (type === 'escalation_watcher') { // NEU: Dynamischer Eskalations-W√§chter
        if (!caseData.violations || !caseData.timeline || !caseData.financials) {
            showStatus("Bitte Chronologie, Verst√∂√üe und Fristen extrahieren (Gesamtanalyse starten).", true);
            isKiProcessing = false; toggleKiButtons(true); return; // FR√úHZEITIGES ENDE
        }
        prompt = `F√ºhre eine strategische Fristen- und Eskalationsanalyse durch. Bewerte den aktuellen Status der wichtigsten Frist (aus financials.frist). Bewerte den "Strategischen Drucklevel" f√ºr die n√§chsten 3 Schritte (Niedrig, Mittel, Hoch, Kritisch) basierend auf der Chronologie und den Verst√∂√üen. Generiere einen internen Bericht (Markdown-Format) mit einem dynamischen Zeitstrahl und der Neubewertung. Gib nur den formatierten Markdown-Text aus. Fallkontext:\n\n${contextToSend}`;
        systemInstruction = escalationWatcherSystemInstruction; // KORRIGIERT: Nutzt dedizierte Instruktion
        loadingOverlayId = 'timeline';
        statusElementId = 'highlighted-text'; // Output in den Quelltext-Viewer
        generationConfig = {};

    } else if (type === 'actor_mapper') { // NEU: Visueller Aktenstruktur-Mapper
         if (!rawCaseText || !caseData.timeline) {
            showStatus("Bitte Rohtext und Chronologie laden (Demo laden).", true);
            isKiProcessing = false; toggleKiButtons(true); return; // FR√úHZEITIGES ENDE
        }
        prompt = `Generiere den kompletten HTML-Code (mit SVG/JavaScript) f√ºr ein interaktives Netzwerkdiagramm. Die Knoten sind die Akteure (Parteien, Zeugen, GF, Firmen) und die Kanten zeigen die Beziehungen (z.B. 'ist Zeuge f√ºr', 'droht'). Visualisiere die Akteure aus dem Rohtext und der Chronologie. Gib nur den HTML-Code zur√ºck. Fallkontext:\n\n${contextToSend}`;
        systemInstruction = actorMapperSystemInstruction;
        loadingOverlayId = 'data-input'; 
        statusElementId = 'status-message';
        generationConfig = {};
        
    } else {
        isKiProcessing = false; 
        toggleKiButtons(true);
        return;
    }
    
    // NEU: Loading-Anzeige f√ºr die Analyse-Sektionen
    if (['violations', 'evidence', 'judgment', 'causality', 'due_diligence', 'triage_filter', 'gap_analysis', 'precedent_matrix', 'escalation_watcher'].includes(type)) { // Watcher hinzugef√ºgt
        getElement(statusElementId).innerHTML = '<p class="text-blue-500 text-center py-8">KI analysiert Dokument und bewertet Relevanz...</p>';
    } else if (['draft', 'client_letter', 'presentation', 'brao_report', 'secretarial_draft', 'synthesis_report', 'reliability_score', 'template_extractor', 'negotiation_mandate'].includes(type)) { // Mandate hinzugef√ºgt
        getElement(statusElementId).textContent = "Generiere Entwurf..."; 
        const sectionOverlay = document.getElementById(loadingOverlayId)?.querySelector('#ai-loading-overlay'); 
        if (sectionOverlay) sectionOverlay.classList.remove('hidden');
        else getElement('strategy-loading-overlay').classList.remove('hidden'); 
    } else if (type === 'impact_report') { 
        getElement('impact-chart-container').classList.add('hidden');
        getElement(statusElementId).innerHTML = '<p class="text-blue-500 text-center py-8">Generiere visuellen Impact Report...</p>';

    } else if (type === 'audit' || type === 'precedent_export' || type === 'rvg_calculator' || type === 'rvg_justification' || type === 'impact_dashboard' || type === 'actor_mapper') { // Dashboard hinzugef√ºgt
        showStatus(`KI generiert ${type === 'audit' ? 'Audit-Bericht' : (type === 'precedent_export' ? 'Pr√§zedenzfall-Export' : (type === 'rvg_justification' ? 'Abrechnungs-Justifizierung' : (type === 'impact_dashboard' ? 'Dashboard' : (type === 'actor_mapper' ? 'Aktenstruktur-Mapper' : 'Kostenberechnung'))))}...`, false);
    } else {
        if (type === 'date_extraction' || type === 'financial_extraction') {
             showStatus("KI versucht, Daten zu erkennen...", false);
        } else {
            const sectionOverlay = document.getElementById(loadingOverlayId)?.querySelector('#ai-loading-overlay'); 
            if (sectionOverlay) sectionOverlay.classList.remove('hidden');
            else getElement('strategy-loading-overlay').classList.remove('hidden'); 
            try { getElement(statusElementId).textContent = "Generierung gestartet..."; } catch (e) { showStatus("Generierung gestartet...", false); }
        }
    }
    
    try {
        const generatedContent = await postMessageToWorker({
            type: 'GENERATE',
            prompt: prompt,
            systemInstruction: systemInstruction,
            generationConfig: generationConfig
            // API Key wird NICHT gesendet, da der Worker ihn hat
        });
        
        if (type === 'impact_dashboard' || type === 'actor_mapper') {
             // Da Dashboard/Mapper HTML ist, wird es direkt in den Quelltext-Viewer geschrieben
             const htmlOutput = generatedContent;
             // Ersetze alle `<script>` und `<style>` Tags in der Pre-Anzeige (OPTIONAL: f√ºr sauberen Text)
             const cleanedContent = htmlOutput.replace(/<script\b[^>]*>([\s\S]*?)<\/script>/gi, '\n[... JavaScript Code Block ...]\n')
                                            .replace(/<style\b[^>]*>([\s\S]*?)<\/style>/gi, '\n[... CSS Style Block ...]\n');
             
             getElement('highlighted-text').textContent = cleanedContent;
             showStatus(`‚ú® Interaktive Visualisierung generiert. Siehe Quelltext-Analyse.`, false);
             setActiveSection('raw-text-viewer');
             
        } else if (!generatedContent) {
            throw new Error("KI hat leere oder ung√ºltige Daten zur√ºckgegeben.");
        }
        
        if (type === 'financial_extraction') {
            const caseName = getElement('input-caseName').value.trim();
            const frist = getElement('input-frist').value.trim();

            if (!caseName) {
                throw new Error("Bitte Falltitel eingeben.");
            }

            // NEU: Zahlen in die Input-Felder schreiben
            getElement('input-schmerzensgeld').value = generatedContent.schmerzensgeld || 0;
            getElement('input-bezahlterBetrug').value = generatedContent.bezahlterBetrug || 0;

            const success = completeDataAnalysis(caseName, generatedContent.schmerzensgeld, generatedContent.bezahlterBetrug, frist, rawCaseText);
            
            if (success) {
                showStatus(`‚ú® Finanzdaten erfolgreich extrahiert und Fall visualisiert.`, false);
                if (type === 'financial_extraction') { 
                    setActiveSection('overview');
                }
            } else {
                 showStatus(`Fehler beim Abschlie√üen der Analyse nach der Extraktion.`, true);
            }
            
        } else if (type === 'draft' || type === 'client_letter' || type === 'secretarial_draft' || type === 'synthesis_report' || type === 'reliability_score' || type === 'negotiation_mandate') { // Mandate hinzugef√ºgt
             getElement('draft-output').textContent = generatedContent;
             getElement('strategy-loading-overlay').classList.add('hidden');
             showStatus(`Dokumenten-Entwurf erfolgreich generiert.`, false);
             if (type === 'synthesis_report' || type === 'reliability_score' || type === 'negotiation_mandate') {
                 setActiveSection('next-steps');
             }

        } else if (type === 'presentation' || type === 'escalation_watcher') { // Watcher hinzugef√ºgt
             getElement('highlighted-text').textContent = generatedContent;
             getElement('strategy-loading-overlay').classList.add('hidden');
             showStatus(`Pr√§sentation erfolgreich generiert. Siehe Quelltext-Analyse.`, false);
             setActiveSection('raw-text-viewer');
        
        } else if (type === 'template_extractor') {
            getElement('highlighted-text').textContent = generatedContent;
            showStatus(`‚ú® Best-Practice-Vorlage erfolgreich extrahiert. Siehe Quelltext-Analyse.`, false);
            setActiveSection('raw-text-viewer');

        } else if (type === 'rvg_calculator' || type === 'audit' || type === 'precedent_export' || type === 'causality' || type === 'due_diligence' || type === 'triage_filter' || type === 'brao_report' || type === 'gap_analysis' || type === 'rvg_justification' || type === 'precedent_matrix') { // Matrix hinzugef√ºgt
             const outputElementId = (type === 'brao_report' ? 'brao-report-output' : 'highlighted-text');
             getElement(outputElementId).textContent = generatedContent;
             showStatus(`${type} Bericht generiert. ${type === 'brao_report' ? 'Siehe BRAO-Compliance.' : 'Siehe Quelltext-Analyse.'}`, false);
             
             if (type !== 'brao_report' && type !== 'rvg_justification' && type !== 'synthesis_report') { 
                setActiveSection('raw-text-viewer');
             }
             if (type === 'rvg_justification') {
                 setActiveSection('overview');
             }
             getElement('strategy-loading-overlay').classList.add('hidden');


        } else if (type === 'impact_report') { 
            initImpactChart(generatedContent);
            getElement('impact-chart-container').classList.remove('hidden');
            getElement(statusElementId).innerHTML = ''; 
            showStatus(`Visueller Impact Report generiert.`, false);
            

        } else if (type === 'date_extraction') {
            const extractedDate = generatedContent.extractedDate;
            if (extractedDate && extractedDate !== 'N/A') {
                const parts = extractedDate.split('-');
                if (parts.length === 3) {
                     const formattedDate = `${parts[2]}.${parts[1]}.${parts[0]}`;
                     getElement('input-frist').value = formattedDate;
                     showStatus(`Frist erfolgreich erkannt: ${formattedDate}`, false);
                } else {
                     throw new Error("KI gab ung√ºltiges Datumsformat zur√ºck.");
                }
            } else {
                showStatus("KI konnte keine eindeutige Frist erkennen.", true);
            }
        } else if (type === 'strategy') {
            if (!caseData) caseData = {}; 
            caseData.consequences = generatedContent;
            populateConsequences();
            saveCase();
            getElement(loadingOverlayId).classList.add('hidden');
            showStatus("‚ú® Neue Strategie erfolgreich generiert und gespeichert.", false);
            
        } else if (type === 'tasks') {
            const newTasks = generatedContent.map(task => {
                const today = new Date();
                let dueDate = null;

                if (task.date) {
                    const dateText = task.date.toLowerCase();
                    if (dateText.includes("heute")) {
                        dueDate = today.toISOString().substring(0, 10);
                    } else if (dateText.includes("morgen")) {
                        const tomorrow = new Date(today);
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        dueDate = tomorrow.toISOString().substring(0, 10);
                    } else if (task.date.includes("woche")) {
                        const nextWeek = new Date(today);
                        nextWeek.setDate(nextWeek.getDate() + 7);
                        dueDate = nextWeek.toISOString().substring(0, 10);
                    } else if (task.date.match(/\d{4}-\d{2}-\d{2}/)) {
                         dueDate = task.date.substring(0, 10); 
                    }
                }
                
                return {
                    text: task.text,
                    date: dueDate || '',
                    done: false,
                    id: Date.now() + Math.random() 
                };
            });
            
            caseData.tasks = (caseData.tasks || []).concat(newTasks);
            loadTasks();
            saveCase();
            getElement(loadingOverlayId).classList.add('hidden');
            showStatus(`‚ú® ${newTasks.length} To-Do-Punkte zur Liste hinzugef√ºgt und gespeichert.",`, false);
        } else if (type === 'violations') {
            if (!caseData) caseData = {}; 
            caseData.violations = generatedContent;
            populateViolations();
            saveCase();
            showStatus("Automatisierte Paragraphen-Identifikation abgeschlossen.", false);
        } else if (type === 'evidence') {
            if (!caseData) caseData = {}; 
            caseData.evidence = generatedContent;
            populateEvidence(currentFilter);
            saveCase();
            showStatus("Automatisierte Beweis-Extraktion abgeschlossen.", false);
        } else if (type === 'judgment') {
            if (!caseData) caseData = {}; 
            if (!caseData.judgments) { caseData.judgments = []; } 
            caseData.judgments.push(generatedContent);
            populateJudgments();
            saveCase();
            showStatus(`Urteil "${generatedContent.title}" erfolgreich analysiert (Relevanz: ${generatedContent.relevance}).`, false);
        }


    } catch (error) {
        console.error("Fehler bei der KI-Generierung:", error);
        
        // Spezielle Behandlung, wenn es sich um einen Abbruch handelt (Fehlermeldung wurde bereits in abortAIGeneration behandelt)
        if (error.message.includes("Vorgang abgebrochen")) {
             // Tue nichts, da der UI-Status bereits in abortAIGeneration gesetzt wurde.
        }
        else if (['draft', 'client_letter', 'brao_report', 'secretarial_draft', 'synthesis_report', 'reliability_score', 'template_extractor', 'precedent_matrix', 'negotiation_mandate'].includes(type)) { // Mandate hinzugef√ºgt
             const outputElementId = (type === 'brao_report' ? 'brao-report-output' : 'draft-output');
             getElement(outputElementId).textContent = `FEHLER: Konnte Dokument nicht generieren. Bitte API Key/Worker-URL pr√ºfen. Detail: ${error.message}`;
        } else {
            try {
                const statusEl = document.getElementById(statusElementId); 
                if (statusEl) {
                    statusEl.textContent = `Fehler: ${error.message}. Bitte API Key/Worker-URL pr√ºfen.`;
                } else {
                    showStatus(`Fehler: ${error.message}. Bitte API Key/Worker-URL pr√ºfen.`, true);
                }
            } catch (domError) {
                console.error("DOM-Fehler beim Anzeigen der KI-Fehlermeldung:", domError);
                showStatus(`Fehler: ${error.message}. Bitte API Key/Worker-URL pr√ºfen.`, true);
            }
        }
        
    } finally {
        // Globale Sperre aufheben, wenn es kein Abbruch war
        if (currentRequestId) {
            isKiProcessing = false;
            toggleKiButtons(true);
            getElement('strategy-loading-overlay').classList.add('hidden'); 
            const specificOverlay = document.getElementById(loadingOverlayId)?.querySelector('#ai-loading-overlay'); 
            if(specificOverlay) specificOverlay.classList.add('hidden');
        }
    }
}

// NEU: Funktion zur Steuerung der gesamten Analyse-Kette
async function startFullAnalysis() {
    
    if (isKiProcessing) {
        showStatus("Warten Sie bitte, eine KI-Analyse l√§uft bereits.", true);
        return;
    }

    // 1. Manuelle Inputs und Rohtext pr√ºfen
    const caseName = getElement('input-caseName').value.trim();
    const frist = getElement('input-frist').value.trim();
    const rawText = getElement('raw-text-input').value.trim();

    if (!rawText || !caseName || !frist) {
        showStatus("Bitte f√ºllen Sie den Falltitel, die Frist und den Rohtext aus.", true);
        return;
    }
    
    // STABILISIERUNG: Fristerkennung als obligatorischer erster Schritt, wenn das Format falsch ist
    if (!isValidDate(frist)) {
        showStatus("Frist ung√ºltig. Versuche KI-Erkennung...", false);
        await handleAIGeneration('date_extraction');
        // Nach der KI-Erkennung den Wert neu pr√ºfen
        const newFrist = getElement('input-frist').value.trim();
        if (!isValidDate(newFrist)) {
             showStatus("FEHLER: Frist konnte nicht erkannt werden. Bitte korrigieren Sie das Format (TT.MM.JJJJ).", true);
             return;
        }
    }
    
    const apiKeyInput = getApiKey();
    if (apiKeyInput === '' || apiKeyInput === "AIzaSyC38nnuVefWRyDjiTav6E6AeXjeyBHZdEo") {
        showStatus("WARNUNG: API Key ist entweder leer oder der Google-Platzhalter. Wenn dein Worker den Key nicht enth√§lt, schl√§gt der Aufruf fehl.", true);
    }

    showStatus("Starte vollautomatische Analyse (5 Schritte)...", false);
    setActiveSection('overview');

    // Globale Sperre aktivieren (wird am Ende der Kette durch `handleAIGeneration('tasks')` aufgehoben)
    isKiProcessing = true;
    toggleKiButtons(false);


    try {
        // --- SCHRITT 1: Finanzdaten extrahieren und Basis-Objekt erstellen ---
        showStatus("Extrahiere Finanzdaten und setze Basis-Fall an...", false);
        await handleAIGeneration('financial_extraction');

        // --- SCHRITT 2: Beweislage extrahieren ---
        showStatus("Analysiere Beweislage und Zitate...", false);
        await handleAIGeneration('evidence');

        // --- SCHRITT 3: Rechtsverst√∂√üe identifizieren ---
        showStatus("Identifiziere straf- und zivilrechtliche Verst√∂√üe...", false);
        await handleAIGeneration('violations');

        // --- SCHRITT 4: Strategie generieren ---
        showStatus("Entwickle dreistufigen Aktionsplan und Strategie...", false);
        getElement('strategy-loading-overlay').classList.remove('hidden'); // Manuelles Laden anzeigen
        await handleAIGeneration('strategy');

        // --- SCHRITT 5: To-Do-Punkte erstellen ---
        showStatus("Breche Strategie auf konkrete To-Do-Punkte herunter...", false);
        getElement('strategy-loading-overlay').classList.remove('hidden'); // Manuelles Laden anzeigen
        // Dieses `handleAIGeneration` wird die globale Sperre im 'finally'-Block aufheben.
        await handleAIGeneration('tasks');

        showStatus("‚ú® Gesamtanalyse abgeschlossen! Strategie und To-Dos generiert.", false);
        setActiveSection('next-steps'); // Wechsel zur Strategie-Ansicht

    } catch (error) {
        // Die individuelle handleAIGeneration hat die Sperre bereits aufgehoben (im finally-Block)
        console.error("Fehler in der Gesamtanalyse-Kette:", error);
        // Bei einem Abbruch (AbortError) wird die Fehlermeldung unterdr√ºckt
        if (!error.message.includes("Vorgang abgebrochen")) {
             showStatus(`Schwerwiegender Fehler w√§hrend der Analyse: ${error.message}. Kette abgebrochen.`, true);
        }
    } finally {
        // Obwohl jeder Schritt theoretisch aufr√§umt, stellen wir sicher, dass die Kette nicht im Fehlerfall stecken bleibt.
        if (currentRequestId) { // Nur aufr√§umen, wenn der Request nicht schon durch abortAIGeneration beendet wurde
            isKiProcessing = false;
            toggleKiButtons(true);
        }
    }
}

// NEU: Chart f√ºr Visuellen Impact Report
function initImpactChart(data) {
    const ctx = getElement('impactChart').getContext('2d');
    
    if (impactChartInstance) {
        impactChartInstance.destroy();
    }
    if (!data || data.length === 0) {
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        return;
    }

    const labels = data.map(item => item.title);
    const amounts = data.map(item => item.amount);
    const backgroundColors = data.map(item => item.is_own ? '#ef4444' : '#3b82f6'); // Rot f√ºr eigene Forderung, Blau f√ºr Pr√§zedenzf√§lle
    
    const isDarkMode = document.documentElement.classList.contains('dark');
    const axisColor = isDarkMode ? '#6b7280' : '#4b5563';
    const gridColor = isDarkMode ? '#374151' : '#e5e7eb';

    impactChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Schmerzensgeld in ‚Ç¨',
                data: amounts,
                backgroundColor: backgroundColors,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y', // Balken horizontal
            scales: {
                x: {
                    beginAtZero: true,
                    title: { display: true, text: 'Euro (‚Ç¨)', color: axisColor },
                    ticks: { color: axisColor },
                    grid: { color: gridColor }
                },
                y: {
                    ticks: { color: axisColor },
                    grid: { display: false }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: { 
                    callbacks: { 
                        label: function(context) { 
                            const isOwn = data[context.dataIndex]?.is_own ? ' (Eigene Forderung)' : ''; // Absicherung
                            return context.dataset.label + ': ‚Ç¨' + context.parsed.x.toLocaleString('de-DE') + isOwn; 
                        } 
                    } 
                }
            }
        }
    });
}

// --- HILFSFUNKTIONEN F√úR WEB WORKER KOMMUNIKATION (KORRIGIERT UND STABILISIERT) ---

// NEUE HILFSFUNKTION: Stabiler DOM-Zugriff
function getElement(id) {
    const el = document.getElementById(id);
    if (!el) {
        // Dieser Fehler ist beabsichtigt. Er stoppt die Ausf√ºhrung,
        // aber gibt eine klare Debug-Meldung statt eines kryptischen 'cannot read properties of null'.
        throw new Error(`Kritisches DOM-Element fehlt: ID '${id}' wurde nicht gefunden. HTML und JS pr√ºfen.`);
    }
    return el;
}

// Globale Worker-Instanz
let aiWorker = null;
// Promise Resolver/Rejecter f√ºr die Worker-Kommunikation
// KORREKTUR: Verwende eine Map, um Race Conditions zu verhindern
let workerResolvers = new Map();

function initializeWorker() {
    // FIX: Die Escape-Sequenzen f√ºr den Worker m√ºssen hier korrekt gesetzt werden
    const safeWorkerUrl = JSON.stringify(CLOUDFLARE_WORKER_URL);
    const safeGeminiModel = JSON.stringify(GEMINI_MODEL);
    const safeChatSystemInstruction = JSON.stringify(chatSystemInstruction);
    
    // Web Worker Code (KORRIGIERT: Final stabilisiertes JSON-Parsing und ABORT-Logik)
    const workerCode = `
        const workerUrl = ${safeWorkerUrl};
        const geminiModel = ${safeGeminiModel};
        const chatSystemInstruction = ${safeChatSystemInstruction};
        
        let activeControllers = new Map(); // NEU: F√ºr AbortController

        async function fetchWithRetry(url, options) {
            let retries = 0;
            const maxRetries = 3;
            // NEU: options.signal muss jetzt √ºbergeben werden
            const signal = options.signal;
            
            while (retries < maxRetries) {
                try {
                    // NEU: Pr√ºfe, ob Signal ausgel√∂st wurde
                    if (signal && signal.aborted) throw new DOMException("Vorgang abgebrochen", "AbortError");
                    
                    const response = await fetch(url, options);
                    
                    // NEU: Pr√ºfe auf Signal nach dem Fetch (wird bei Fetch-Rejection nicht erreicht)
                    if (signal && signal.aborted) throw new DOMException("Vorgang abgebrochen", "AbortError");
                    
                    // NEU: Status-Code 403 (Forbidden) oder 401 (Unauthorized) sind kritisch.
                    if (response.status === 403 || response.status === 401) {
                         throw new Error("Worker-Fehler: API Key im Worker ist ung√ºltig oder fehlt (Status: " + response.status + ").");
                    }
                    if (!response.ok) throw new Error("Worker-Aufruf oder API Call failed with status " + response.status + " (" + response.statusText + ")");
                    return response;
                } catch (error) {
                    if (error.name === 'AbortError') throw error; // Wichtig: Abbr√ºche sofort weiterleiten
                    
                    retries++;
                    if (retries >= maxRetries) throw error;
                    await new Promise(r => setTimeout(r, Math.pow(2, retries) * 1000));
                }
            }
        }

        // STABILISIERUNG: Robustere JSON-Extraktion
        function extractJson(text) {
            // Entferne Markdown-Ticks und unn√∂tige Whitespaces am Anfang/Ende
            text = text.replace(/\\\`\\\`\\\`json/g, '').replace(/\\\`\\\`\\\`/g, '').trim();
            
            let jsonStart = -1;
            let jsonEnd = -1;
            
            // Finde den ersten √∂ffnenden Bracket, der nicht innerhalb eines String-Literals ist
            const findJsonStart = (s) => {
                let depth = 0;
                let inString = false;
                for (let i = 0; i < s.length; i++) {
                    const char = s[i];
                    // √úberpr√ºfe, ob es sich um ein unescaped Anf√ºhrungszeichen handelt
                    if (char === '\\"' && i > 0 && s[i-1] !== '\\\\') {
                        inString = !inString;
                    }
                    if (!inString) {
                         if (char === '{' || char === '[') {
                             if (depth === 0) return i;
                             depth++;
                         } else if (char === '}' || char === ']') {
                             depth--;
                         }
                    }
                }
                return -1;
            };

            // Finde den passenden End-Bracket
            const findJsonEnd = (s, startIndex) => {
                let bracketCount = 0;
                let inString = false;
                const startBracket = s[startIndex];
                const endBracket = (startBracket === '{') ? '}' : ']';

                for (let i = startIndex; i < s.length; i++) {
                    const char = s[i];
                    if (char === '\\"' && i > 0 && s[i-1] !== '\\\\') {
                        inString = !inString;
                    }
                    if (!inString) {
                        if (char === startBracket) {
                            bracketCount++;
                        } else if (char === endBracket) {
                            bracketCount--;
                            if (bracketCount === 0) {
                                return i;
                            }
                        }
                    }
                }
                return -1; // Unvollst√§ndiges JSON
            };
            
            jsonStart = findJsonStart(text);
            
            if (jsonStart !== -1) {
                jsonEnd = findJsonEnd(text, jsonStart);
                if (jsonEnd !== -1) {
                    // JSON String extrahieren, einschlie√ülich des End-Brackets
                    return text.substring(jsonStart, jsonEnd + 1);
                }
            }
            
            // Fallback: Wenn keine JSON-Struktur gefunden wurde, gib den Originaltext zur√ºck
            return text;
        }

        // KORRIGIERT: Nutzt Worker URL und f√ºgt Model hinzu
        async function runGeminiGenerationWorker(prompt, systemInstruction, generationConfig, requestId) {
            const apiUrl = workerUrl; 
            
            // NEU: AbortController Setup
            const controller = new AbortController();
            activeControllers.set(requestId, controller);

            const payload = {
                model: geminiModel, // Model an Worker senden
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: generationConfig
            };
            
            try {
                const response = await fetchWithRetry(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload),
                    signal: controller.signal // Signal √ºbergeben
                });
                
                const result = await response.json();
                
                // √úberpr√ºfen, ob der Worker einen Fehler zur√ºckgegeben hat (z.B. 403 oder API-Fehler)
                if (result.error) {
                     throw new Error("Worker/KI Fehler: " + result.error.message);
                }
                
                const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!aiText) {
                     const errorMsg = result.error ? result.error.message : "KI hat leere Antwort generiert.";
                     throw new Error(errorMsg);
                }
                
                let finalContent;
                if (generationConfig.responseMimeType === "application/json") {
                    try {
                        const cleanJsonString = extractJson(aiText);
                        if (cleanJsonString && (cleanJsonString.startsWith('{') || cleanJsonString.startsWith('['))) {
                             finalContent = JSON.parse(cleanJsonString);
                        } else {
                            finalContent = JSON.parse(aiText);
                        }
                    } catch (e) {
                        throw new Error("Ung√ºltige JSON-Struktur von der KI erhalten: " + e.message + " (Auszug: " + aiText.substring(0, 50) + "...)");
                    }
                } else {
                    finalContent = aiText;
                }
            
                // Cleanup:
                activeControllers.delete(requestId);
                return finalContent;
            } catch(error) {
                activeControllers.delete(requestId);
                throw error;
            }
        }
        
        // KORRIGIERT: Nutzt Worker URL und f√ºgt Model hinzu
        async function callGeminiApiWorker(prompt, imageBase64 = null, mimeType = null, context, requestId) {
            const apiUrl = workerUrl; 
            
            // NEU: AbortController Setup
            const controller = new AbortController();
            activeControllers.set(requestId, controller);

            let chatParts = [];
            // F√ºge Kontext als ersten Teil des Prompts hinzu
            chatParts.push({ text: "KONTEXT: " + context }); 
            if (imageBase64 && mimeType) {
                chatParts.push({ inlineData: { mimeType: mimeType, data: imageBase64 } });
            }
            chatParts.push({ text: prompt });
            
            const payload = {
                model: geminiModel, // Model an Worker senden
                contents: [{ parts: chatParts }],
                systemInstruction: { parts: [{ text: chatSystemInstruction }] },
            };
            
            try {
                const response = await fetchWithRetry(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload),
                    signal: controller.signal // Signal √ºbergeben
                });
                const result = await response.json();
                 // √úberpr√ºfen, ob der Worker einen Fehler zur√ºckgegeben hat
                if (result.error) {
                     throw new Error("Worker/KI Fehler: " + result.error.message);
                }
                const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!aiText) {
                     const errorMsg = result.error ? result.error.message : "KI hat leere Antwort generiert.";
                     throw new Error(errorMsg);
                }
                
                // Cleanup:
                activeControllers.delete(requestId);
                return aiText;

            } catch (error) {
                activeControllers.delete(requestId);
                throw error;
            }
        }

        self.onmessage = async (e) => {
            const { type, prompt, systemInstruction, generationConfig, apiKey, imageBase64, mimeType, context, requestId } = e.data;
            
            // NEU: ABORT HANDLER
            if (type === 'ABORT') {
                if (activeControllers.has(requestId)) {
                    // Sendet das Abort-Signal an den Controller
                    activeControllers.get(requestId).abort(); 
                    activeControllers.delete(requestId);
                    // Best√§tige den Abbruch
                    self.postMessage({ type: 'ABORT_ACK', requestId: requestId }); 
                }
                return; // Beende die Verarbeitung des ABORT-Befehls
            }
            
            // Bestehende GENERATE Logik
            try {
                let result;
                if (type === 'GENERATE') {
                    // WICHTIG: apiKey wird im Worker nicht verwendet, da der Worker den Proxy nutzt
                    result = await runGeminiGenerationWorker(prompt, systemInstruction, generationConfig, requestId);
                    self.postMessage({ type: 'GENERATE_SUCCESS', content: result, requestId: requestId });
                } else if (type === 'CHAT') {
                    // WICHTIG: apiKey wird im Worker nicht verwendet, da der Worker den Proxy nutzt
                    result = await callGeminiApiWorker(prompt, imageBase64, mimeType, context, requestId);
                    self.postMessage({ type: 'CHAT_SUCCESS', content: result });
                }
            } catch (error) {
                // Bei einem AbortError wird die Message mit dem Namen der Exception gef√ºllt
                console.error("Worker Error:", error.message);
                self.postMessage({ type: 'ERROR', message: error.message, requestId: requestId, errorName: error.name });
            }
        };
    `;
    
    // Die Web Worker-Konstruktion
    const blob = new Blob([workerCode], { type: 'application/javascript' });
    aiWorker = new Worker(URL.createObjectURL(blob));
    
    // Nachrichtensystem des Haupt-Threads
    aiWorker.onmessage = (e) => {
        // KORREKTUR: requestId und NEU: errorName aus der Antwort extrahieren
        const { type, content, message, requestId, errorName } = e.data;
        
        // Chat-Nachrichten haben keine requestId und werden separat behandelt
        if (type === 'CHAT_SUCCESS') {
            handleWorkerChatResponse(content);
            return;
        }

        // Resolver f√ºr die spezifische Anfrage finden
        const resolver = workerResolvers.get(requestId);
        if (!resolver) {
            console.warn("Worker-Antwort ohne passenden Resolver empfangen (vielleicht veraltet):", requestId);
            return;
        }
        
        if (type === 'GENERATE_SUCCESS') {
            resolver.resolve(content);
        } else if (type === 'ERROR') {
            // Spezielle Behandlung f√ºr AbortError: wird in postMessageToWorker gehandhabt
            const error = new Error(message);
            error.name = errorName || 'Error';
            resolver.reject(error);
        }
        
        // Resolver nach Gebrauch l√∂schen
        workerResolvers.delete(requestId);
    };

    aiWorker.onerror = (error) => {
        console.error("Web Worker schwerwiegender Fehler:", error);
        
        // KORREKTUR: Alle wartenden Promises ablehnen
        const errorMessage = "Web Worker Fehler. Konsole pr√ºfen.";
        workerResolvers.forEach(resolver => resolver.reject(new Error(errorMessage)));
        workerResolvers.clear();
    };
}

// NEU: Globale Funktion zum Abbrechen der KI-Generierung
function abortAIGeneration() {
    if (!currentRequestId) {
        showStatus("Kein aktiver KI-Vorgang zum Abbrechen.", true);
        return;
    }
    
    const reqId = currentRequestId;
    
    // 1. Sende ABORT-Signal an den Worker. Dies f√ºhrt zur Ablehnung des fetch im Worker.
    aiWorker.postMessage({ type: 'ABORT', requestId: reqId });
    
    // 2. Clear main thread state and update UI immediately
    const resolver = workerResolvers.get(reqId);
    if (resolver) {
        workerResolvers.delete(reqId);
    }
    
    // Wir setzen currentRequestId auf null, da der Vorgang f√ºr die UI beendet ist
    currentRequestId = null;
    
    // 3. UI aufr√§umen und Status aktualisieren
    isKiProcessing = false;
    toggleKiButtons(true); // Re-enable buttons, hide abort button
    showStatus("KI-Generierung durch Benutzer abgebrochen.", true);
    
    // Zus√§tzliche Aufr√§umarbeiten (Loading-Overlays ausblenden)
    getElement('strategy-loading-overlay').classList.add('hidden'); 
    const draftOutput = document.getElementById('draft-output');
    if (draftOutput) draftOutput.textContent = "Der Entwurf wurde abgebrochen.";
    const highlightedText = document.getElementById('highlighted-text');
    if (highlightedText) highlightedText.textContent = "Der Bericht wurde abgebrochen.";
}

// Generische Funktion zum Senden einer Nachricht an den Worker und Warten auf das Ergebnis
function postMessageToWorker(data) {
    if (!aiWorker) {
        return Promise.reject(new Error("KI-Worker nicht initialisiert."));
    }

    // KORREKTUR: Eindeutige ID f√ºr jede Anfrage
    const requestId = crypto.randomUUID();
    data.requestId = requestId; // ID zur Anfrage hinzuf√ºgen

    // NEU: Setze den globalen Tracker
    currentRequestId = requestId;

    return new Promise((resolve, reject) => {
        // Speichere Resolver/Rejecter f√ºr die asynchrone Antwort und l√∂sche den Tracker
        workerResolvers.set(requestId, { 
            resolve: (content) => { 
                currentRequestId = null; 
                resolve(content); 
            }, 
            reject: (error) => { 
                // Spezielle Behandlung f√ºr AbortError, um Kette zu brechen, aber UI-Fehler zu verhindern
                if (error.name === 'AbortError' || error.message.includes("Vorgang abgebrochen")) {
                    currentRequestId = null; // Clear Tracker, da beendet
                    reject(new Error("Vorgang abgebrochen.")); // Bricht die await-Kette ohne Fehlermeldung
                } else {
                    currentRequestId = null; 
                    reject(error);
                }
            } 
        });
        aiWorker.postMessage(data);
    });
}

// Spezifischer Handler f√ºr Chat-Antworten vom Worker
function handleWorkerChatResponse(aiText) {
    showAiLoading(false);
    
    // Da wir den Kontext im Worker selbst hinzuf√ºgen, muss hier nur die UI aktualisiert werden
    renderChatMessage(aiText, 'ai');
             
    // Setze File-Status zur√ºck
    uploadedFileBase64 = null;
    uploadedFileMimeType = null;
    getElement('ai-file-upload').value = ''; 
    getElement('file-preview-container').classList.add('hidden');
    
    // Deaktiviere die globale Sperre
    isKiProcessing = false;
    toggleKiButtons(true);
    
    // Clear Request ID
    currentRequestId = null;
}

// --- ENDE WEB WORKER HILFSFUNKTIONEN ---


// --- Firestore CRUD Functions (Angepasst f√ºr neue Struktur) ---

async function saveCase() {
    if (!caseData || !userId) {
        showStatus("Fehler: Bitte analysieren Sie zuerst Daten und warten Sie auf die Authentifizierung.", true);
        return;
    }
    
    // STABILISIERUNG: Notizen aus dem Feld auslesen und in caseData speichern
    if (!caseData.notes) caseData.notes = {}; // Absicherung
    caseData.notes.overview = getElement('notes-overview').value;
    
    // Pr√ºfen, ob es sich um ein Update oder einen neuen Fall handelt
    let caseId = caseData.id || Date.now().toString(); 
    const caseName = caseData.caseName || `Unbenannter Fall - ${new Date().toLocaleDateString()}`;
    
    const caseToSave = {
        id: caseId,
        name: caseName,
        createdAt: caseData.createdAt || new Date().toISOString(),
        data: JSON.stringify(caseData),
        rawText: rawCaseText 
    };

    try {
        await setDoc(doc(caseCollectionRef, caseId), caseToSave);
        showStatus(`Fall "${caseName}" erfolgreich gespeichert (Cloud).`, false);
        // Stelle sicher, dass die ID im aktuellen Datenobjekt gespeichert wird
        caseData.id = caseId;
        loadCaseList();
    } catch (e) {
        console.error("Fehler beim Speichern:", e);
        showStatus("Speicherfehler: Konnte Fall nicht in Firestore speichern.", true);
    }
}

async function deleteCase(caseId, caseName) {
    // KEIN alert/confirm verwenden, da dies im iFrame blockiert wird. Verwenden Sie eine benutzerdefinierte Meldung, aber hier simulieren wir den L√∂schvorgang nach der Abfrage.
    if (!confirm(`Sind Sie sicher, dass Sie den Fall "${caseName}" unwiderruflich l√∂schen m√∂chten?`)) {
        return;
    }
    
    try {
        await deleteDoc(doc(caseCollectionRef, caseId));
        showStatus(`Fall "${caseName}" erfolgreich gel√∂scht.`, false);
        loadCaseList();
        
        // Optional: Wenn der gel√∂schte Fall gerade angezeigt wird, lade Demo
        if (caseData && caseData.id === caseId) {
             loadCaseData(demoData, demoRawText);
             setActiveSection('overview');
        }

    } catch (e) {
        console.error("Fehler beim L√∂schen:", e);
        showStatus("L√∂schfehler: Konnte Fall nicht l√∂schen.", true);
    }
}


async function loadCase(caseId, caseName) {
    try {
        const caseQuery = query(caseCollectionRef, where('id', '==', caseId));
        const snapshot = await getDocs(caseQuery);
        
        if (snapshot.empty) {
             showStatus(`Fehler: Fall "${caseName}" nicht gefunden.`, true);
             return;
        }

        const docData = snapshot.docs[0].data();
        const loadedData = JSON.parse(docData.data);
        const loadedRawText = docData.rawText || ''; 
        
        // F√ºge die ID f√ºr Updates hinzu
        loadedData.id = caseId; 

        // Aktualisiere die Input-Felder mit geladenen Daten
        getElement('input-caseName').value = loadedData.caseName || '';
        getElement('input-schmerzensgeld').value = loadedData.financials?.schmerzensgeld || 0;
        getElement('input-bezahlterBetrug').value = loadedData.financials?.bezahlterBetrug || 0;
        getElement('input-frist').value = loadedData.financials?.frist || '';
        getElement('raw-text-input').value = loadedRawText; // Lade Rohtext in Input
        getElement('notes-overview').value = loadedData.notes?.overview || ''; // STABILISIERUNG: Notizen laden
        
        // Lade die Daten in die Visualisierung
        loadCaseData(loadedData, loadedRawText);
        showStatus(`Fall "${caseName}" geladen und visualisiert.`, false);
        setActiveSection('overview');

    } catch (e) {
        console.error("Fehler beim Laden:", e);
        showStatus("Fehler beim Laden des Falls. JSON-Struktur pr√ºfen.", true);
    }
}

async function loadCaseList() {
    if (!caseCollectionRef) return;
    const listContainer = getElement('case-list-container');
    listContainer.innerHTML = '<p class="text-gray-500 text-sm">F√§lle werden geladen...</p>';

    try {
        const q = query(caseCollectionRef, orderBy('createdAt', 'desc'));
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
            listContainer.innerHTML = '<p class="text-gray-500 text-sm">Keine gespeicherten F√§lle gefunden.</p>';
            return;
        }

        listContainer.innerHTML = '';
        snapshot.forEach(doc => {
            const data = doc.data();
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-3 bg-gray-50 hover:bg-gray-100 rounded-lg cursor-pointer transition';
            div.innerHTML = `
                <span class="text-sm font-medium text-gray-800" title="${data.name}">${data.name}</span>
                <div class="space-x-2">
                    <button class="text-xs text-blue-600 hover:text-blue-800 font-semibold load-case-btn" data-id="${data.id}" data-name="${data.name}">Laden</button>
                    <button class="text-xs text-red-600 hover:text-red-800 font-semibold delete-case-btn" data-id="${data.id}" data-name="${data.name}">L√∂schen</button>
                </div>
            `;
            listContainer.appendChild(div);
        });

        // Event Listener f√ºr geladene F√§lle
        listContainer.querySelectorAll('.load-case-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                const caseId = e.target.getAttribute('data-id');
                const caseName = e.target.getAttribute('data-name');
                loadCase(caseId, caseName);
            });
        });
        
         // Event Listener f√ºr L√∂schen
        listContainer.querySelectorAll('.delete-case-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                const caseId = e.target.getAttribute('data-id');
                const caseName = e.target.getAttribute('data-name');
                deleteCase(caseId, caseName);
            });
        });


    } catch (e) {
        console.error("Fehler beim Laden der Fallliste:", e);
        listContainer.innerHTML = '<p class="text-red-500 text-sm">Fehler beim Abrufen der Fallliste.</p>';
    }
}


// --- Task Management Functions ---
function loadTasks() {
    const container = getElement('task-list-container');
    container.innerHTML = '';
    
    if (!caseData || !caseData.tasks || caseData.tasks.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">Keine Aufgaben f√ºr diesen Fall hinterlegt.</p>';
        return;
    }
    
    // KORREKTUR: Sichereres Sortieren
    caseData.tasks.sort((a, b) => {
        const dateA = a?.date ? new Date(a.date).getTime() : Infinity; // Absicherung
        const dateB = b?.date ? new Date(b.date).getTime() : Infinity; // Absicherung
        if (dateA === dateB) return 0;
        if (isNaN(dateA)) return 1; // Ung√ºltige/leere Daten nach hinten
        if (isNaN(dateB)) return -1;
        return dateA - dateB;
    });

    caseData.tasks.forEach((task, index) => {
        if (!task) return; // Absicherung
        const div = document.createElement('div');
        const isDone = task.done;
        const taskClass = isDone ? 'task-done' : 'task-open';
        // KORREKTUR: Sicherere Datumsumwandlung
        let dateText = 'Keine Frist';
        if (task.date) {
            try {
                // Versuche, das Datum zu parsen und zu formatieren
                const parsedDate = new Date(task.date + 'T00:00:00'); // F√ºge Zeit hinzu, um Zeitzonenprobleme zu minimieren
                if (!isNaN(parsedDate)) {
                     dateText = parsedDate.toLocaleDateString('de-DE');
                } else {
                     console.warn("Ung√ºltiges Datum im Task gefunden:", task.date);
                }
            } catch (e) { console.warn("Fehler beim Parsen des Task-Datums:", task.date, e); }
        }
        
        div.className = `p-3 rounded-lg shadow transition duration-150 border-l-4 bg-white flex justify-between items-center ${taskClass}`;
        div.innerHTML = `
            <div class="flex items-center space-x-3">
                <input type="checkbox" id="task-${index}" data-index="${index}" ${isDone ? 'checked' : ''} class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                <label for="task-${index}" class="text-sm font-medium text-gray-700 ${isDone ? 'line-through text-gray-500' : ''}">
                    ${task.text || 'Unbenannte Aufgabe'} 
                </label>
            </div>
            <div class="flex items-center space-x-3">
                <span class="text-xs text-gray-500">${dateText}</span>
                <button data-index="${index}" class="text-red-500 hover:text-red-700 delete-task-btn">üóëÔ∏è</button>
            </div>
        `;
        container.appendChild(div);
    });

    // Event Listener f√ºr Checkbox
    container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
            const index = parseInt(e.target.dataset.index);
            if (caseData.tasks && caseData.tasks[index]) { // Absicherung
                caseData.tasks[index].done = e.target.checked;
                saveCase(); // Speichere den Fall bei Status√§nderung
                loadTasks(); // Aktualisiere die Liste
            }
        });
    });
    
    // Event Listener f√ºr L√∂schen
    container.querySelectorAll('.delete-task-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            if (caseData.tasks && caseData.tasks[index]) { // Absicherung
                caseData.tasks.splice(index, 1);
                saveCase(); // Speichere den Fall nach dem L√∂schen
                loadTasks(); // Aktualisiere die Liste
            }
        });
    });
}

function addTask() {
    const textInput = getElement('task-input-text');
    const dateInput = getElement('task-input-date');
    const text = textInput.value.trim();
    const date = dateInput.value; // Format: YYYY-MM-DD
    
    if (!text) {
        showStatus("Bitte geben Sie einen Aufgabentext ein.", true);
        return;
    }
    if (!caseData) {
        showStatus("Bitte laden oder analysieren Sie zuerst einen Fall.", true);
        return;
    }
    
    if (!caseData.tasks) {
        caseData.tasks = [];
    }

    caseData.tasks.push({
        text: text,
        date: date,
        done: false,
        id: Date.now()
    });

    textInput.value = '';
    dateInput.value = '';
    
    saveCase(); // Speichere den neuen Task
    loadTasks(); // Aktualisiere die Liste
}


// --- Core Functions (Teile wie zuvor) ---

// NEU: Datenvalidierung
function isValidDate(dateString) {
    // Erwartet Format TT.MM.JJJJ
    const regex = /^(\d{1,2})\.(\d{1,2})\.(\d{4})$/;
    if (!dateString || !regex.test(dateString)) return false; // Fr√ºhzeitiger Abbruch bei leerem String

    const parts = dateString.match(regex);
    const day = parseInt(parts[1], 10);
    const month = parseInt(parts[2], 10);
    const year = parseInt(parts[3], 10);

    // Grundlegende Datumspr√ºfung (Monat ist 0-basiert)
    const date = new Date(year, month - 1, day);
    // Zus√§tzliche Pr√ºfung, ob das erstellte Datum den Eingabewerten entspricht (f√§ngt ung√ºltige Tage/Monate ab)
    return date.getFullYear() === year && date.getMonth() === month - 1 && date.getDate() === day;
}

function highlightRawText(keyword) {
    const viewer = getElement('highlighted-text');
    let textToDisplay = rawCaseText;
    
    if (keyword && rawCaseText) {
        // Entferne alle vorherigen Highlights
        textToDisplay = rawCaseText.replace(/<\/?span[^>]*>/g, ' ');
        
        // Finde und ersetze den Keyword mit dem Highlight-Span
        const regex = new RegExp('(' + keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
        textToDisplay = textToDisplay.replace(regex, '<span class="highlight">$&</span>');
    }

    viewer.innerHTML = textToDisplay.replace(/\n/g, '<br>');
    setActiveSection('raw-text-viewer');
}

function showStatus(message, isError = true) {
    const statusEl = getElement('status-message');
    statusEl.textContent = message;
    statusEl.className = `text-sm mt-1 ${isError ? 'text-red-500' : 'text-green-600'}`;
    // Entferne den Timeout, um die Meldungen auch bei l√§ngeren Prozessen sichtbar zu lassen
    if (!isKiProcessing) {
        setTimeout(() => { statusEl.textContent = ''; }, 5000);
    }
}

function setActiveSection(targetId) {
    // 1. Alle Content-Bereiche deaktivieren
    document.querySelectorAll('.content-area').forEach(sec => sec.classList.remove('active'));
    getElement(targetId).classList.add('active');
    
    // Pr√ºfen, ob Dark Mode aktiv ist
    const isDark = document.documentElement.classList.contains('dark');
    
    // 2. Alle Nav-Links deaktivieren und Standardfarben setzen
    document.querySelectorAll('.nav-link').forEach(link => {
        // Entferne ALLE aktiven Klassen
        link.classList.remove('active', 'font-semibold', 'bg-blue-100', 'text-blue-800', 'bg-gray-700', 'text-white');
        
        // Standardfarbe f√ºr inaktive Links
        if (isDark) {
            link.classList.add('text-gray-300', 'hover:bg-gray-700'); 
            link.classList.remove('text-gray-800');
        } else {
            // KORREKTUR: text-gray-800 f√ºr bessere Sichtbarkeit
            link.classList.add('text-gray-800', 'hover:bg-gray-50'); 
            link.classList.remove('text-gray-300', 'hover:bg-gray-700');
        }
    });

    // 3. Aktuellen Link aktivieren und Tailwind-Farben setzen
    const activeLink = document.querySelector(`[data-target="${targetId}"]`);
    if (activeLink) { // Absicherung
        activeLink.classList.add('active', 'font-semibold');
        
        // Setze explizite aktive Farben basierend auf dem Modus
        if (isDark) {
            // Dunkel: Aktiver Link ist Dunkelgrau (bg-gray-700) mit wei√üer Schrift (text-white)
            activeLink.classList.add('bg-gray-700', 'text-white');
            activeLink.classList.remove('text-gray-800', 'hover:bg-gray-50');
        } else {
            // Hell: Aktiver Link ist Hellblau (bg-blue-100) mit Dunkelblau (text-blue-800)
            activeLink.classList.add('bg-blue-100', 'text-blue-800');
            activeLink.classList.remove('text-gray-800', 'hover:bg-gray-50');
        }
    }
    
    // STABILISIERUNG: Synchronisiere Input-Felder, wenn zu "Daten-Management" navigiert wird
    if (targetId === 'data-input' && caseData) {
        getElement('input-caseName').value = caseData.caseName || '';
        getElement('input-schmerzensgeld').value = caseData.financials?.schmerzensgeld || 0;
        getElement('input-bezahlterBetrug').value = caseData.financials?.bezahlterBetrug || 0;
        getElement('input-frist').value = caseData.financials?.frist || '';
        getElement('raw-text-input').value = rawCaseText || '';
        getElement('notes-overview').value = caseData.notes?.overview || ''; // Auch Notizen synchronisieren
    }
}

function loadCaseData(data, rawText) {
    if (financialsChartInstance) {
        financialsChartInstance.destroy(); 
    }
    if (scenarioChartInstance) {
        scenarioChartInstance.destroy();
    }
    if (impactChartInstance) { // NEU: Impact Chart zerst√∂ren
        impactChartInstance.destroy();
    }
    
    // KORREKTUR: Abgesicherte Pr√ºfung
    if (!data || !data.caseName || !data.financials) {
        showStatus("Fehler: Ung√ºltige oder unvollst√§ndige JSON-Struktur.", true);
         // Lade Demo als Fallfallback
        caseData = JSON.parse(JSON.stringify(demoData)); // Tiefe Kopie
        rawCaseText = demoRawText;
        console.warn("Lade Demo-Daten aufgrund ung√ºltiger Eingabedaten.");
        // return; // Nicht returnen, sondern Demo laden
    } else {
        caseData = data;
        rawCaseText = rawText || ''; // Speichere Rohtext global
    }
    
    // Initialisiere Rohtext-Viewer
    getElement('highlighted-text').textContent = rawCaseText || 'Kein Rohtext vorhanden.';
    
    // Header aktualisieren
    getElement('case-title').textContent = `Fall: ${caseData.caseName}`;
    getElement('case-subtitle').textContent = caseData.caseSubtitle || 'Fallanalyse geladen.';
    
    // Alle Komponenten neu rendern (dies sollte das Verschwinden der Daten beheben)
    populateOverview();
    populateTimeline();
    // Setze Filter zur√ºck und rendere neu
    currentFilter = "ALL";
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active-filter', 'bg-gray-400', 'bg-red-400', 'bg-yellow-400', 'bg-gray-700', 'bg-red-900', 'bg-yellow-900'));
    
    // Standard-Filter-Klasse zuweisen
    const isDark = document.documentElement.classList.contains('dark');
    const allFilterBtn = document.querySelector('[data-filter="ALL"]');
    if (allFilterBtn) {
        allFilterBtn.classList.add('active-filter');
        allFilterBtn.classList.add(isDark ? 'bg-gray-700' : 'bg-gray-400');
    }

    populateEvidence(currentFilter);

    populateViolations();
    populateConsequences();
    populateJudgments(); // NEU
    populateBraoCompliance(); // NEU: BRAO Section initialisieren
    loadTasks(); // Lade Aufgaben f√ºr diesen Fall
    initFinancialsChart();
    
    // Initialisiere Szenario-Chart mit Standardwert
    const hypoSettlementInput = getElement('input-hypo-settlement');
    // KORREKTUR: Pr√ºfe auf NaN
    const initialHypoValue = parseFloat(hypoSettlementInput.value) || 0;
    initScenarioChart(initialHypoValue);
    
    // NEU: Countdown starten
    updateDeadlineCountdown();

    showStatus("Daten erfolgreich geladen und Anwendung aktualisiert.", false);
    // Behalte die aktuelle Ansicht bei, statt immer zu 'overview' zu wechseln
    // setActiveSection('overview'); 
}

function completeDataAnalysis(caseName, schmerzensgeld, bezahlterBetrug, frist, rawText) {
    try {
        // Falls noch keine caseData existieren (nach KI-Extraktion)
        if (!caseData) {
            // STABILISIERUNG: Nutze eine saubere Struktur, falls die Demo-Daten nicht geladen wurden
            caseData = {
                id: null,
                caseName: caseName,
                caseSubtitle: `Fallanalyse erstellt am ${new Date().toLocaleDateString()}`,
                financials: {},
                timeline: [],
                evidence: [],
                violations: [],
                consequences: [],
                judgments: [],
                notes: { overview: "" },
                tasks: []
            };
        }

        // 1. Daten in das globale Objekt √ºbertragen
        caseData.caseName = caseName;
        // KORREKTUR: Stelle sicher, dass financials existiert
        if (!caseData.financials) { caseData.financials = {}; }
        // KORREKTUR: Validiere Zahlen
        caseData.financials.schmerzensgeld = parseInt(schmerzensgeld, 10) || 0;
        caseData.financials.bezahlterBetrug = parseInt(bezahlterBetrug, 10) || 0;
        caseData.financials.frist = frist; // Datum wird separat validiert
        // Wichtig: anwaltskostenSchaetzung muss f√ºr die Charts vorhanden sein
        if (!caseData.financials.anwaltskostenSchaetzung) {
            caseData.financials.anwaltskostenSchaetzung = 2000;
        }

        // 2. Rufe die Ladefunktion auf, um die UI mit den neuen Daten zu f√ºllen
        loadCaseData(caseData, rawText);

        return true;
    } catch (e) {
        console.error("Fehler beim Abschlie√üen der Analyse:", e);
        return false;
    }
}


function analyzeAndStructureData() {
    try {
        const caseName = getElement('input-caseName').value.trim();
        const frist = getElement('input-frist').value.trim();
        const rawText = getElement('raw-text-input').value.trim();
        
        // --- NEU: Zuerst pr√ºfen, ob Rohtext vorhanden ist ---
        if (!rawText) {
            showStatus("Bitte Rohtext einf√ºgen, bevor Sie die KI-Extraktion starten.", true);
            return;
        }

        // Starte KI-Extraktion der Finanzdaten
        handleAIGeneration('financial_extraction');

    } catch (e) {
        console.error("Analysefehler:", e);
        showStatus("Ein unerwarteter Fehler ist bei der Analyse aufgetreten. Konsole pr√ºfen.", true);
    }
}

function exportCaseJson() {
    if (!caseData) {
        showStatus("Fehler: Laden oder analysieren Sie zuerst einen Fall.", true);
        return;
    }
    
    // STABILISIERUNG: Notizen aus dem Feld auslesen und in caseData speichern
    if (!caseData.notes) caseData.notes = {}; // Absicherung
    caseData.notes.overview = getElement('notes-overview').value;

    // Kombiniere die Daten und den Rohtext f√ºr den Export
    const exportObject = {
        caseData: caseData,
        rawText: rawCaseText
    };

    // Erstelle den JSON-String
    const jsonString = JSON.stringify(exportObject, null, 2);
    
    // Erstelle ein Blob und einen Download-Link
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `Analysebericht_${caseData.caseName.replace(/\s/g, '_')}_${new Date().toISOString().substring(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showStatus("JSON-Analyse erfolgreich exportiert (Lokal).", false);
}

function importJsonFile(event) {
    const file = event.target.files[0];
    if (!file) {
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const content = e.target.result;
            const importedObject = JSON.parse(content);
            
            if (!importedObject.caseData || typeof importedObject.rawText === 'undefined') { // Pr√ºfe auf 'undefined' statt nur '!'
                throw new Error("Fehlende Struktur: Die Datei muss 'caseData' und 'rawText' enthalten.");
            }
            
            // Lade die Daten
            loadCaseData(importedObject.caseData, importedObject.rawText);

            // Synchronisiere die Eingabefelder (wichtig f√ºr die Bearbeitung)
            const d = importedObject.caseData;
            getElement('input-caseName').value = d.caseName || '';
            getElement('input-schmerzensgeld').value = d.financials?.schmerzensgeld || 0;
            getElement('input-bezahlterBetrug').value = d.financials?.bezahlterBetrug || 0;
            getElement('input-frist').value = d.financials?.frist || '';
            getElement('raw-text-input').value = importedObject.rawText || '';
            getElement('notes-overview').value = d.notes?.overview || ''; // STABILISIERUNG: Notizen laden

            showStatus(`Fall '${d.caseName}' erfolgreich aus JSON importiert (Lokal).`, false);
        } catch (error) {
            console.error("Importfehler:", error);
            showStatus(`Fehler beim Laden der JSON-Datei. Ist das Format korrekt? ${error.message}`, true);
        }
    };
    reader.readAsText(file);
}


function populateOverview() {
    if (!caseData) return; // KORREKTUR: Fr√ºhzeitiger Abbruch
    
    // KORREKTUR: Abgesicherte Zugriffe (Optional Chaining)
    const schmerzensgeldEl = document.querySelector('[data-stat="schmerzensgeld"]');
    if (schmerzensgeldEl) {
        schmerzensgeldEl.textContent = `${(caseData.financials?.schmerzensgeld || 0).toLocaleString('de-DE')} ‚Ç¨`;
    }
    
    const betrugEl = document.querySelector('[data-stat="bezahlterBetrug"]');
    if (betrugEl) {
        betrugEl.textContent = `${(caseData.financials?.bezahlterBetrug || 0).toLocaleString('de-DE')} ‚Ç¨`;
    }
    
    const fristEl = document.querySelector('[data-stat="frist"]');
    if (fristEl) {
        fristEl.textContent = caseData.financials?.frist || 'N.A.';
    }

    // Notizen laden
    const notesOverview = caseData.notes?.overview || '';
    getElement('notes-overview').value = notesOverview;
    
    // Setze Hypothetischen Wert auf die H√§lfte der Forderung
    const defaultHypo = (caseData.financials?.schmerzensgeld || 0) / 2;
    getElement('input-hypo-settlement').value = defaultHypo.toFixed(0);

    // Starte Chart mit dem neuen Wert
    initFinancialsChart();
    // KORREKTUR: Stelle sicher, dass der Wert eine Zahl ist
    initScenarioChart(parseFloat(getElement('input-hypo-settlement').value) || 0);
}

function populateTimeline() {
    const list = getElement('timeline-list');
    list.innerHTML = '';
    if (!caseData || !caseData.timeline || caseData.timeline.length === 0) {
        list.innerHTML = '<p class="text-gray-500">Keine Zeitstrahl-Daten vorhanden.</p>';
        getElement('timeline-detail-box').classList.add('hidden');
        return;
    }
    
    caseData.timeline.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'p-3 rounded-lg shadow cursor-pointer transition duration-150 border-l-4 border-gray-200 hover:border-blue-500 timeline-item';
        // KORREKTUR: Fehlendes data-index Attribut hinzugef√ºgt, damit die Klick-Logik funktioniert
        div.setAttribute('data-index', index); 
        div.innerHTML = `
            <p class="text-xs font-semibold text-gray-700">${item.date}</p>
            <h4 class="text-sm font-medium text-gray-900">${item.title}</h4> 
        `;
        list.appendChild(div);
    });

    // STABILISIERUNG: Event Listener f√ºr Timeline
    list.addEventListener('click', (e) => {
        const itemElement = e.target.closest('.timeline-item');
        if (itemElement) {
            const index = itemElement.getAttribute('data-index'); // KORREKTUR: index jetzt √ºber getAttribute holen
            if (index === null || !caseData.timeline || !caseData.timeline[index]) return; // Absicherung
            
            const item = caseData.timeline[index];
            const isDark = document.documentElement.classList.contains('dark');

            document.querySelectorAll('.timeline-item').forEach(el => {
                // Reset auf neutrale Standardfarben
                el.classList.remove('bg-blue-100', 'border-blue-500', 'bg-gray-800');
                el.classList.add('border-gray-200');
                // F√ºr Dark Mode den Reset auf die Dark-Farbe anpassen
                if (isDark) {
                     el.classList.remove('bg-gray-800'); // Entferne aktive Farbe
                     // KORREKTUR: Nicht 'bg-gray-100' hinzuf√ºgen, da dies von '.dark .timeline-item' √ºberschrieben wird
                }
            });
            
            itemElement.classList.remove('border-gray-200');

            // Setze aktive Farbe basierend auf Modus
            if (isDark) {
                itemElement.classList.add('bg-gray-800', 'border-blue-500'); // Dunkelgrau aktiv
            } else {
                itemElement.classList.add('bg-blue-100', 'border-blue-500'); // Hellblau aktiv
            }

            const detailBox = getElement('timeline-detail-box');
            getElement('timeline-detail-title').textContent = `${item.date}: ${item.title}`;
            getElement('timeline-detail-text').textContent = item.detail;
            detailBox.classList.remove('hidden');
        }
    });
}

function populateEvidence(filter) {
    const container = getElement('evidence-container');
    container.innerHTML = '';
    
    // Sperrung der Buttons wird jetzt zentral √ºber toggleKiButtons(true/false) gesteuert

    if (!caseData || !caseData.evidence || caseData.evidence.length === 0) {
        container.innerHTML = '<p class="text-gray-500">Klicken Sie auf "KI-Beweise extrahieren" zur Automatisierung.</p>';
        return;
    }
    
    const filteredEvidence = caseData.evidence.filter(item => {
        return filter === "ALL" || (item && item.strength === filter); // Absicherung
    });

    filteredEvidence.forEach(item => {
        if (!item) return; // Absicherung
        const div = document.createElement('div');
        // Ensure dynamic components reset dark mode classes correctly
        div.className = `p-4 rounded-lg border-l-4 border-gray-200 bg-white shadow-sm cursor-pointer hover:shadow-lg transition duration-150 strength-${item.strength}`;
        div.innerHTML = `
            <h4 class="flex items-center text-md font-semibold text-gray-900"> 
                <span class="text-xl mr-3">${item.icon || 'üìÑ'}</span> ${item.title || 'Unbenannter Beweis'} 
                <span class="ml-2 text-xs font-normal text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full">${item.type || 'Indiz'}</span>
            </h4>
            <p class="mt-2 text-sm text-gray-700">${item.detail || 'Keine Details.'}</p> <!-- KORREKTUR: text-gray-600 auf text-gray-700 -->
        `;
        // F√ºgt den Klick-Handler f√ºr Source-Linking hinzu
        if (item.keyword) {
            div.addEventListener('click', () => highlightRawText(item.keyword));
            div.setAttribute('title', `Klicken Sie, um '${item.keyword}' im Quelltext zu finden.`);
        }
        container.appendChild(div);
    });
}

function populateViolations() {
    const container = getElement('violations-container');
    container.innerHTML = '';
    
    // Sperrung der Buttons wird jetzt zentral √ºber toggleKiButtons(true/false) gesteuert

    if (!caseData || !caseData.violations || caseData.violations.length === 0) {
        container.innerHTML = '<p class="text-gray-500">Klicken Sie auf "KI-Paragraphen identifizieren" zur Automatisierung.</p>';
        return;
    }
    
    caseData.violations.forEach(item => {
        if (!item) return; // Absicherung
        const div = document.createElement('div');
        div.className = 'p-5 rounded-lg border-t-4 border-red-500 bg-white shadow-md';
        div.innerHTML = `
            <p class="text-xs font-mono text-red-600 mb-1">${item.code || 'N.A.'}</p>
            <h4 class="text-lg font-bold text-gray-900">${item.title || 'Unbenannter Versto√ü'}</h4> <!-- KORREKTUR: text-gray-800 auf text-gray-900 f√ºr besseren Kontrast -->
            <p class="text-sm text-gray-700 mt-2">${item.detail || 'Keine Details.'}</p> <!-- KORREKTUR: text-gray-500 auf text-gray-700 -->
             <p class="text-xs font-medium text-blue-700 mt-3">Betroffene: ${item.target || 'N.A.'}</p>
        `;
        container.appendChild(div);
    });
}

function populateConsequences() {
    const container = getElement('consequences-container');
    container.innerHTML = '';
    
    // Sperrung der Buttons wird jetzt zentral √ºber toggleKiButtons(true/false) gesteuert

    if (!caseData || !caseData.consequences || caseData.consequences.length === 0) {
        container.innerHTML = '<p class="text-gray-500">Klicken Sie auf "KI-Aktionsplan erstellen", um die Strategie zu generieren.</p>';
        return;
    }
    
    caseData.consequences.forEach((section, index) => {
        if (!section) return; // Absicherung
        const ulItems = (section.steps || []).map(step => `<li class="text-sm text-gray-600">${step}</li>`).join('');
        
        const itemDiv = document.createElement('div'); // KORREKTUR: Hier itemDiv verwenden
        // Ensure dynamic components reset dark mode classes correctly
        itemDiv.className = 'border border-gray-200 rounded-lg overflow-hidden';
        itemDiv.innerHTML = `
            <div class="accordion-header flex justify-between items-center p-4 bg-white hover:bg-gray-50 transition duration-150" data-target-id="acc-body-${index}">
                <h4 class="text-lg font-bold text-blue-800">${section.target || 'Unbenanntes Ziel'}</h4>
                <span class="text-xl text-gray-500 transform transition duration-300 rotate-0" data-arrow-id="arrow-${index}">+</span>
            </div>
            <div id="acc-body-${index}" class="accordion-body p-4 bg-gray-50 hidden">
                <ul class="list-disc ml-5 space-y-1">
                    ${ulItems}
                </ul>
            </div>
        `;
        container.appendChild(itemDiv); // KORREKTUR: Hier itemDiv verwenden
    });

    // Add accordion logic
    // KORREKTUR: Listener ist global in DOMContentLoaded gesetzt und funktioniert hier durch Event Bubbling
}

function populateJudgments() {
    const container = getElement('judgment-analysis-output');
    container.innerHTML = '';
    
    // Impact Chart Container ausblenden
    getElement('impact-chart-container').classList.add('hidden');

    // Sperrung der Buttons wird jetzt zentral √ºber toggleKiButtons(true/false) gesteuert

    if (!caseData || !caseData.judgments || caseData.judgments.length === 0) {
        container.innerHTML = '<p class="text-gray-500">Urteile werden hier nach Relevanz angezeigt, sobald die Analyse abgeschlossen ist.</p>';
        return;
    }

    // Sortiere Urteile nach Relevanz: HOCH > MITTEL > NIEDRIG
    const relevanceOrder = { 'HOCH': 3, 'MITTEL': 2, 'NIEDRIG': 1 };
    caseData.judgments.sort((a, b) => (relevanceOrder[b?.relevance] || 0) - (relevanceOrder[a?.relevance] || 0)); // Absicherung

    caseData.judgments.forEach((judgment) => {
        if (!judgment) return; // Absicherung
        const relevanceClass = `strength-${judgment.relevance === 'HOCH' ? 'HIGH' : (judgment.relevance === 'MITTEL' ? 'MEDIUM' : 'LOW')}`;
        
        const keyFactsHtml = (judgment.keyFacts || []).map(fact => `<li class="text-sm text-gray-600">${fact}</li>`).join('');

        const div = document.createElement('div');
        div.className = `p-4 rounded-lg border-l-4 ${relevanceClass} bg-white shadow-md`;
        div.innerHTML = `
            <h4 class="text-lg font-bold text-blue-900 mb-2">${judgment.title || 'Unbenanntes Urteil'}</h4>
            <div class="flex justify-between items-start mb-2">
                <div>
                    <p class="text-xs font-semibold text-gray-600">Relevanz:</p>
                    <span class="inline-block px-3 py-1 text-sm font-bold rounded-full ${judgment.relevance === 'HOCH' ? 'bg-red-500 text-white' : (judgment.relevance === 'MITTEL' ? 'bg-yellow-500 text-gray-800' : 'bg-gray-300 text-gray-800')}">
                        ${judgment.relevance || 'N.A.'}
                    </span>
                </div>
                <div>
                    <p class="text-xs font-semibold text-gray-600">Tenor:</p>
                    <p class="text-sm text-gray-800 italic">${judgment.tenor || 'N.A.'}</p>
                </div>
            </div>
            
            <div class="mt-4 border-t pt-3">
                 <p class="text-sm font-semibold text-gray-800 mb-1">Zentrale Fakten des Urteils:</p>
                 <ul class="list-disc ml-5 space-y-1">
                    ${keyFactsHtml}
                </ul>
            </div>

            <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                <p class="text-sm font-semibold text-blue-700">Begr√ºndung der Relevanz:</p>
                <p class="text-sm text-gray-700">${judgment.justification || 'Keine Begr√ºndung.'}</p>
            </div>
        `;
        container.appendChild(div);
    });
}

// NEU: Funktion zum Initialisieren der BRAO Section
function populateBraoCompliance() {
    const reportOutput = getElement('brao-report-output');
    reportOutput.textContent = 'Klicken Sie auf "KI-Analyse: BRAO-Aspekte im Falltext", um den Text zu scannen.';
}

function initFinancialsChart() {
    const ctx = getElement('financialsChart').getContext('2d');
    
    if (financialsChartInstance) {
        financialsChartInstance.destroy();
    }

    if (!caseData) { // KORREKTUR: Fr√ºhzeitiger Abbruch
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        return;
    }
    
    // KORREKTUR: Abgesicherte Zugriffe
    const anwaltskosten = caseData.financials?.anwaltskostenSchaetzung || 2000;
    
    const isDarkMode = document.documentElement.classList.contains('dark');
    const axisColor = isDarkMode ? '#6b7280' : '#4b5563'; // gray-500 : gray-600
    const gridColor = isDarkMode ? '#374151' : '#e5e7eb'; // gray-700 : gray-200

    financialsChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Betrugsschaden (Gezahlt)', 'Geforderter Schadenersatz', 'Gesch. Anwaltskosten Gegenseite*'],
            datasets: [{
                label: 'Betrag in ‚Ç¨',
                data: [
                    caseData.financials?.bezahlterBetrug || 0, 
                    caseData.financials?.schmerzensgeld || 0, 
                    anwaltskosten
                ],
                backgroundColor: [
                    '#FBBF24', 
                    '#10b981', 
                    '#ef4444' 
                ],
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Euro (‚Ç¨)', color: axisColor },
                    ticks: { color: axisColor },
                    grid: { color: gridColor }
                },
                x: {
                    ticks: { 
                        color: axisColor,
                        // KORREKTUR: Mobile Optimierung f√ºr Labels
                         maxRotation: 45,
                         minRotation: 45,
                         autoSkip: false,
                         font: { size: 10 }
                    },
                    grid: { color: gridColor }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: { callbacks: { label: function(context) { return context.dataset.label + ': ‚Ç¨' + context.parsed.y.toLocaleString('de-DE'); } } }
            }
        }
    });
}

function initScenarioChart(hypoValueInput) {
    const ctx = getElement('scenarioChart').getContext('2d');
    
    // KORREKTUR: Eingabewert validieren
    const hypoValue = parseFloat(hypoValueInput) || 0;

    if (scenarioChartInstance) {
        scenarioChartInstance.destroy();
    }
    if (!caseData) { // KORREKTUR: Fr√ºhzeitiger Abbruch
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        return;
    }

    // KORREKTUR: Abgesicherte Zugriffe
    const anwaltskosten = caseData.financials?.anwaltskostenSchaetzung || 2000;
    const trialRisk = anwaltskosten + (caseData.financials?.schmerzensgeld || 0);
    const settlementCost = hypoValue; // Bereits validiert
    
    const isDarkMode = document.documentElement.classList.contains('dark');
    const axisColor = isDarkMode ? '#6b7280' : '#4b5563';
    const gridColor = isDarkMode ? '#374151' : '#e5e7eb';

    scenarioChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Kosten bei Vergleich', 'Risiko bei Prozessverlust'],
            datasets: [{
                label: 'Betrag in ‚Ç¨',
                data: [settlementCost, trialRisk],
                backgroundColor: [
                    settlementCost < trialRisk ? '#3b82f6' : '#ef4444', 
                    '#1e3a8a' 
                ],
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Euro (‚Ç¨)', color: axisColor },
                    ticks: { color: axisColor },
                    grid: { color: gridColor }
                },
                x: {
                    ticks: { 
                        color: axisColor,
                        // KORREKTUR: Mobile Optimierung f√ºr Labels
                         maxRotation: 45,
                         minRotation: 45,
                         autoSkip: false,
                         font: { size: 10 }
                    },
                    grid: { color: gridColor }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: { callbacks: { label: function(context) { return context.dataset.label + ': ‚Ç¨' + context.parsed.y.toLocaleString('de-DE'); } } }
            }
        }
    });
}

function updateDeadlineCountdown() {
    // KORREKTUR: Abgesicherter Zugriff
    const deadlineText = caseData?.financials?.frist;
    const deadlineEl = getElement('deadline-warning');
    
    if (!deadlineText) {
        deadlineEl.innerHTML = '';
        deadlineEl.className = 'hidden';
        return;
    }

    const parts = deadlineText.split('.');
    if (parts.length !== 3 || !isValidDate(deadlineText)) { // Pr√ºfung auf g√ºltiges Format hinzugef√ºgt
        // Bei falschem Format (z.B. N.A.) oder ung√ºltigem Datum
        deadlineEl.innerHTML = `‚ö†Ô∏è Formatfehler: Frist '${deadlineText}' muss TT.MM.JJJJ sein und g√ºltig sein.`;
        deadlineEl.className = 'p-4 rounded-lg mb-6 flex items-center border bg-red-100 text-red-800 border-red-500';
        return;
    }

    const [day, month, year] = parts.map(Number);
    // Erstelle ein Datumsobjekt im Format JJJJ-MM-TT
    const deadlineDate = new Date(year, month - 1, day);
    const today = new Date();
    // Setze die Uhrzeit f√ºr heute auf 00:00:00 f√ºr eine faire Tagesberechnung
    today.setHours(0, 0, 0, 0);

    // --- NEUE KORREKTUR: Auf ung√ºltiges Datum pr√ºfen (redundant durch isValidDate, aber sicher ist sicher) ---
    if (isNaN(deadlineDate.getTime())) {
        deadlineEl.innerHTML = `‚ö†Ô∏è Formatfehler: Frist '${deadlineText}' ist ein ung√ºltiges Datum.`;
        deadlineEl.className = 'p-4 rounded-lg mb-6 flex items-center border bg-red-100 text-red-800 border-red-500';
        return;
    }
    // --- ENDE KORREKTUR ---

    const timeDiff = deadlineDate.getTime() - today.getTime();
    const daysRemaining = Math.ceil(timeDiff / (1000 * 3600 * 24));
    
    let message = '';
    let bgColor = '';
    let icon = '';

    if (daysRemaining > 7) {
        message = `Noch ${daysRemaining} Tage bis zur Frist.`;
        bgColor = 'bg-blue-100 text-blue-800 border-blue-400';
        icon = 'üîî';
    } else if (daysRemaining >= 0) {
        message = `NUR NOCH ${daysRemaining} TAGE! Hohes Risiko!`;
        bgColor = 'bg-yellow-100 text-yellow-800 border-yellow-500';
        icon = '‚ö†Ô∏è';
    } else {
        message = `FRIST VERSTRICHEN (${Math.abs(daysRemaining)} Tage). Sofortige juristische Schritte einleiten!`;
        bgColor = 'bg-red-100 text-red-800 border-red-500';
        icon = 'üö®';
    }
    
    deadlineEl.className = `p-4 rounded-lg mb-6 flex items-center border ${bgColor}`;
    deadlineEl.innerHTML = `<span class="text-2xl mr-3">${icon}</span> <p class="font-bold">${message}</p>`;
}

function toggleDarkMode() {
    const htmlEl = document.documentElement;
    htmlEl.classList.toggle('dark');
    const isDark = htmlEl.classList.contains('dark');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    
    // Charts neu initialisieren, um die Farben der Achsen/Grids anzupassen
    if (caseData) {
        initFinancialsChart();
        // KORREKTUR: Stelle sicher, dass der Wert eine Zahl ist
        initScenarioChart(parseFloat(getElement('input-hypo-settlement').value) || 0);
        
        // NEU: Explizites Neuzeichnen aller Komponenten, um thematische Fehler zu beheben
        // Dies erzwingt die korrekte Tailwind-Farbzuweisung basierend auf dem neuen 'dark' Status
        populateOverview(); 
        populateTimeline();
        populateEvidence(currentFilter); 
        populateViolations();
        populateConsequences();
        populateJudgments(); // NEU
        populateBraoCompliance(); // NEU
        loadTasks();
    }
    
    // Manuelle Korrektur des aktiven Nav-Links nach dem Moduswechsel
    // Hier rufen wir setActiveSection auf, um die aktiven Klassen neu zu setzen
    const activeLink = document.querySelector('.nav-link.active');
    const activeTarget = activeLink ? activeLink.getAttribute('data-target') : 'overview';
    setActiveSection(activeTarget); // Setzt die korrekten Klassen basierend auf dem aktuellen Modus
    
    // Button Text anpassen
    getElement('toggle-dark-mode-btn').textContent = isDark ? 'Tagmodus ‚òÄÔ∏è' : 'Nachtmodus üåô';
}

// --- KI CHAT FUNKTIONALIT√ÑT (Angepasst f√ºr Worker) ---

function renderChatMessage(text, sender, imageBase64 = null) {
    const chatHistory = getElement('chat-history');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message text-sm ${sender === 'user' ? 'user-message' : 'ai-message'}`;

    let content = '';

    // Beim Benutzerbeitrag das Bild/Dokument anzeigen
    if (sender === 'user' && imageBase64 && uploadedFileMimeType) {
        content += `<p class="text-xs italic mb-2">Dokument/Bild zur Analyse hochgeladen:</p>`;
        content += `<img src="data:${uploadedFileMimeType};base64,${imageBase64}" class="max-w-full h-auto rounded-lg mb-2 border border-gray-300 shadow-md" style="max-height: 200px; object-fit: contain;">`;
    }
    
    // STABILISIERUNG: Spezielle Behandlung f√ºr den Fall, dass nur ein Bild und kein Text gesendet wurde
    if (text) {
        // Ersetze Markdown-Zeilenumbr√ºche durch HTML-Zeilenumbr√ºche f√ºr die Anzeige im div
        content += text.replace(/\n/g, '<br>');
    } else if (sender === 'user' && imageBase64) {
         // Nur Bild/Dokument hochgeladen, aber kein Text-Prompt
         content += "*(Dokument zur Analyse)*";
    }

    messageDiv.innerHTML = content;
    chatHistory.appendChild(messageDiv);
    chatHistory.scrollTop = chatHistory.scrollHeight; // Scrolle nach unten
}

function showAiLoading(show) {
    isAiLoading = show;
    const sendBtn = getElement('send-chat-btn');
    const input = getElement('chat-input');
    
    // Chat-Buttons werden √ºber toggleKiButtons gesteuert, ABER isAiLoading h√§lt den Indicator

    // KORREKTUR: Verwende getElement, aber pr√ºfe, ob es bereits existiert
    let loadingIndicator = document.getElementById('ai-loading-indicator'); // Hier document.getElementById, da es dynamisch ist
    
    if (show) {
        if (!loadingIndicator) {
            const history = getElement('chat-history');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'ai-loading-indicator';
            loadingDiv.className = 'chat-message ai-message flex items-center';
            loadingDiv.innerHTML = 'KI analysiert<span class="loading-dot"></span><span class="loading-dot"></span><span class="loading-dot"></span>';
            history.appendChild(loadingDiv);
            history.scrollTop = history.scrollHeight;
        }
    } else {
        if (loadingIndicator) {
            loadingIndicator.remove();
        }
    }
}

async function callGeminiApi(prompt, imageBase64 = null, mimeType = null) {
    // Globale Sperre ist bereits in handleChatSubmit aktiviert
    showAiLoading(true);
    
    const apiKeyInput = getApiKey();
    if (apiKeyInput === '' || apiKeyInput === "AIzaSyC38nnuVefWRyDjiTav6E6AeXjeyBHZdEo") {
        renderChatMessage("WARNUNG: API Key ist entweder leer oder der Google-Platzhalter. Wenn dein Worker den Key nicht enth√§lt, schl√§gt der Aufruf fehl.", 'ai');
    }


    let context = getCaseContext();
    const contextToSendToChat = context; // Aktuell Originaltext
    
    // Starte den Worker und warte auf das Ergebnis
    try {
        aiWorker.postMessage({
            type: 'CHAT',
            prompt: prompt, 
            systemInstruction: chatSystemInstruction,
            imageBase64: imageBase64, 
            mimeType: mimeType,
            context: contextToSendToChat, 
            apiKey: apiKeyInput // Wird vom Worker ignoriert, aber hier f√ºr Vollst√§ndigkeit gesendet
        });
        // Note: showAiLoading(false) und die Zur√ºcksetzung der Datei wird durch den Worker-Callback ausgel√∂st.
    } catch (error) {
        showAiLoading(false);
        renderChatMessage(`Es tut mir leid, die KI-Analyse ist fehlgeschlagen: ${error.message}.`, 'ai');
        // Setze File-Status zur√ºck
        uploadedFileBase64 = null;
        uploadedFileMimeType = null;
        getElement('ai-file-upload').value = ''; 
        getElement('file-preview-container').classList.add('hidden');
        
        // Deaktiviere die globale Sperre bei Fehler
        isKiProcessing = false;
        toggleKiButtons(true);
    }
}

async function handleChatSubmit() {
    if (isKiProcessing) return; // Globale Sperre pr√ºfen

    const inputElement = getElement('chat-input');
    const prompt = inputElement.value.trim();

    if (!prompt && !uploadedFileBase64) {
        return;
    }
    if (!caseData) {
        renderChatMessage("Bitte laden Sie zuerst einen Fall (Demo oder eigenen) im 'Daten-Management'.", 'ai');
        return;
    }
    
    // Globale Sperre aktivieren
    isKiProcessing = true;
    toggleKiButtons(false); 

    // Zeige Benutzer-Nachricht an (√ºbergebe Base64 an den Renderer f√ºr das User-Bubble)
    renderChatMessage(prompt, 'user', uploadedFileBase64);

    // Starte API Call
    inputElement.value = ''; // Input leeren
    // Wichtig: Beim Start der API muss der Zustand des Bildes und des Prompts √ºbergeben werden
    await callGeminiApi(prompt, uploadedFileBase64, uploadedFileMimeType);
}


// Hilfsfunktion: Konvertiert File zu Base64 und aktualisiert Previews
function fileToBase64(file) {
    // Nur Bilder (image/*) akzeptieren
    if (!file.type.startsWith('image/')) {
        showStatus("Bitte w√§hle eine Bilddatei (JPEG, PNG etc.) zur Analyse.", true);
        clearFileSelection();
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        // Base64-String extrahieren (ohne MimeType Header)
        uploadedFileBase64 = e.target.result.split(',')[1];
        uploadedFileMimeType = file.type;
        
        // Update UI
        getElement('file-preview-name').textContent = `Dokument bereit: ${file.name}`;
        getElement('file-preview-container').classList.remove('hidden');
        // Aktiviere den Chat-Senden-Button
        toggleKiButtons(true); 
    };
    reader.onerror = function() {
        showStatus("Fehler beim Lesen der Datei.", true);
        clearFileSelection();
    };
    reader.readAsDataURL(file);
}

function clearFileSelection() {
    uploadedFileBase64 = null;
    uploadedFileMimeType = null;
    getElement('ai-file-upload').value = ''; // Wichtig, um denselben Dateinamen erneut hochladen zu k√∂nnen
    getElement('file-preview-container').classList.add('hidden');
    
    // Deaktiviere Senden, wenn Input leer ist (wird durch toggleKiButtons() gemacht)
    if (!isKiProcessing) { // Nur wenn nicht gerade eine KI-Anfrage l√§uft
        toggleKiButtons(true); 
    }
}


// --- Event Handlers & Initialization ---

document.addEventListener('DOMContentLoaded', () => {
    
    // NEU: Dark Mode beim Start pr√ºfen und korrigieren
    const storedTheme = localStorage.getItem('theme');
    if (storedTheme === 'dark') {
        document.documentElement.classList.add('dark');
    }
    // Setze den Text des Buttons
    getElement('toggle-dark-mode-btn').textContent = document.documentElement.classList.contains('dark') ? 'Tagmodus ‚òÄÔ∏è' : 'Nachtmodus üåô';


    // Navigation setup
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const target = e.currentTarget.getAttribute('data-target');
            if (target) { 
                setActiveSection(target);
            }
        });
    });
    
    // Filter Event Listener f√ºr Beweise
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const filter = e.target.getAttribute('data-filter');
            currentFilter = filter; 
            
            // UI-Aktualisierung
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active-filter', 'bg-gray-400', 'bg-red-400', 'bg-yellow-400', 'bg-gray-700', 'bg-red-900', 'bg-yellow-900', 'bg-red-100', 'bg-yellow-100', 'bg-gray-200'));
            
            e.target.classList.add('active-filter');
            const isDark = document.documentElement.classList.contains('dark');

            // STABILISIERUNG: Korrekte Zuweisung der Filterklassen (Background Farbe der Buttons)
            if (filter === 'ALL') { e.target.classList.add(isDark ? 'bg-gray-700' : 'bg-gray-400', 'text-gray-800'); }
            if (filter === 'HIGH') { e.target.classList.add(isDark ? 'bg-red-900' : 'bg-red-400', 'text-red-800'); }
            if (filter === 'MEDIUM') { e.target.classList.add(isDark ? 'bg-yellow-900' : 'bg-yellow-400', 'text-yellow-800'); }

            populateEvidence(filter);
        });
    });
    
    // File Upload Listener (Simulates OCR/Text Extraction)
    getElement('file-upload').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            showStatus(`Datei '${file.name}' wurde hochgeladen. Starte simulierte OCR...`, false);
            
            // Simuliert, dass ein l√§ngerer Text extrahiert wurde
            setTimeout(() => {
                 getElement('raw-text-input').value = demoRawText;
                 showStatus("Rohtext extrahiert. Bitte Schl√ºsseldaten manuell pr√ºfen.", false);
            }, 1000);
            
        }
    });

    // Button: Daten analysieren & Visualisieren (Hybrid-Input)
    // KORRIGIERT: Ruft jetzt die Gesamtanalyse-Kette auf
    getElement('analyze-data-btn').addEventListener('click', startFullAnalysis);

    // NEU: Abbrechen Button Listener
    getElement('abort-ki-btn').addEventListener('click', abortAIGeneration);
    
    // Button: Demo laden
    getElement('load-demo-btn').addEventListener('click', () => {
        loadCaseData(demoData, demoRawText);
        getElement('input-caseName').value = demoData.caseName;
        getElement('input-schmerzensgeld').value = demoData.financials.schmerzensgeld;
        getElement('input-bezahlterBetrug').value = demoData.financials.bezahlterBetrug;
        getElement('input-frist').value = demoData.financials.frist;
        getElement('raw-text-input').value = demoRawText;
        getElement('notes-overview').value = demoData.notes.overview; // STABILISIERUNG: Notizen laden
        showStatus("Demo-Fall geladen. Speichern Sie ihn, um Case-Management zu testen.", false);
    });
    
    // Button: JSON Export (Jetzt im Speicherbereich)
    getElement('export-json-btn').addEventListener('click', exportCaseJson);

    // NEU: JSON Import Listener
    getElement('json-upload').addEventListener('change', importJsonFile);

    // Button: Fall speichern
    getElement('save-case-btn').addEventListener('click', saveCase);
    
    // NEU: Szenario Input Listener
    getElement('input-hypo-settlement').addEventListener('input', (e) => {
         // KORREKTUR: Stelle sicher, dass der Wert eine Zahl ist
        initScenarioChart(parseFloat(e.target.value) || 0);
    });
    
    // NEU: Task Input Listener
    getElement('add-task-btn').addEventListener('click', addTask);
    
    // NEU: Fokus Modus Listener
    getElement('toggle-focus-btn').addEventListener('click', () => {
        const container = document.querySelector('.app-container');
        if (container) {
            container.classList.toggle('focus-mode');
        }
    });
    
    // NEU: Dark Mode Toggle Listener
    getElement('toggle-dark-mode-btn').addEventListener('click', toggleDarkMode);
    
    // NEU: KI Strategie-Button Listener
    getElement('generate-strategy-btn').addEventListener('click', () => handleAIGeneration('strategy'));
    
    // NEU: KI To-Do-Button Listener
    getElement('generate-tasks-btn').addEventListener('click', () => handleAIGeneration('tasks'));
    
    // NEU: KI Violations-Button Listener
    getElement('generate-violations-btn').addEventListener('click', () => handleAIGeneration('violations'));

    // NEU: KI Evidence-Button Listener
    getElement('generate-evidence-btn').addEventListener('click', () => handleAIGeneration('evidence'));
    
    // NEU: KI Judgment-Button Listener
    getElement('analyze-judgment-btn').addEventListener('click', () => handleAIGeneration('judgment'));
    
    // NEU: KI Causality Button Listener
    getElement('generate-causality-btn').addEventListener('click', () => handleAIGeneration('causality'));

    // NEU: KI Frist-Extraktions-Button Listener
    getElement('extract-date-btn').addEventListener('click', () => handleAIGeneration('date_extraction'));

    // NEU: KI Schriftsatz-Generierung
    getElement('generate-draft-btn').addEventListener('click', () => handleAIGeneration('draft'));
    
    // NEU: KI Audit-Generierung
    getElement('generate-audit-btn').addEventListener('click', () => handleAIGeneration('audit'));

    // NEU: KI Pr√§zedenzfall-Export
    getElement('export-precedent-btn').addEventListener('click', () => handleAIGeneration('precedent_export'));

    // NEU: Mandanten-Brief Generator
    getElement('generate-client-letter-btn').addEventListener('click', () => handleAIGeneration('client_letter'));

    // NEU: RVG Kosten W√§chter
    getElement('generate-rvg-btn').addEventListener('click', () => handleAIGeneration('rvg_calculator'));
    
    // NEU: RVG Justifizierer
    getElement('generate-justification-btn').addEventListener('click', () => handleAIGeneration('rvg_justification'));


    // NEU: Deep-Due-Diligence-Scanner
    getElement('generate-due-diligence-btn').addEventListener('click', () => handleAIGeneration('due_diligence'));
    
    // NEU: Aktenzeichen-Triage-Filter
    getElement('generate-triage-filter-btn').addEventListener('click', () => handleAIGeneration('triage_filter'));
    
    // NEU: Visueller Impact Report
    getElement('generate-impact-report-btn').addEventListener('click', () => handleAIGeneration('impact_report'));

    // NEU: Pr√§zedenzfall-Abgrenzungs-Matrix
    getElement('generate-precedent-matrix-btn').addEventListener('click', () => handleAIGeneration('precedent_matrix')); // NEU

    // NEU: Pr√§sentations-Generator
    getElement('generate-presentation-btn').addEventListener('click', () => handleAIGeneration('presentation'));
    
    // NEU: BRAO Report Generator
    getElement('generate-brao-report-btn').addEventListener('click', () => handleAIGeneration('brao_report'));
    
    // NEU: Sekretariat Draft Generator
    getElement('generate-secretarial-draft-btn').addEventListener('click', () => handleAIGeneration('secretarial_draft'));
    
    // NEU: Beweisl√ºcken-Scanner Listener
    getElement('generate-gap-analysis-btn').addEventListener('click', () => handleAIGeneration('gap_analysis'));

    // NEU: Strategische Synthese (Prozessphasen-Memo) Listener
    getElement('generate-synthesis-report-btn').addEventListener('click', () => handleAIGeneration('synthesis_report'));
    
    // NEU: Beweis- & Schadenauswirkungs-Dashboard
    getElement('generate-impact-dashboard-btn').addEventListener('click', () => handleAIGeneration('impact_dashboard'));
    
    // NEU: Gegner-Verl√§sslichkeit-Score
    getElement('generate-reliability-score-btn').addEventListener('click', () => handleAIGeneration('reliability_score'));

    // NEU: Verhandlungs-Mandat-Generator
    getElement('generate-negotiation-mandate-btn').addEventListener('click', () => handleAIGeneration('negotiation_mandate'));

    // NEU: Aktenstruktur-Mapper
    getElement('generate-actor-mapper-btn').addEventListener('click', () => handleAIGeneration('actor_mapper'));

    // NEU: Dynamischer Eskalations-W√§chter Listener
    getElement('generate-escalation-watcher-btn').addEventListener('click', () => handleAIGeneration('escalation_watcher'));


    // NEU: Auto-Trigger Logik f√ºr Instant-Analyse
    function checkAndAutoStartAnalysis() {
        const caseName = getElement('input-caseName').value.trim();
        const frist = getElement('input-frist').value.trim();
        const rawText = getElement('raw-text-input').value.trim();

        // Pr√ºfe, ob alle Pflichtfelder ausgef√ºllt und die Frist ein g√ºltiges Format hat
        if (rawText && caseName && frist && isValidDate(frist)) {
            // Wenn alle Daten vorliegen, starte die Analyse (der Button wird ignoriert, wenn bereits geladen wird)
            if (getElement('analyze-data-btn').disabled === false) {
                 // STABILISIERUNG: Deaktiviert, um KI-Kosten zu sparen und den Start explizit zu halten.
            }
        }
    }

    // F√ºge Listener zu den wichtigsten Input-Feldern hinzu
    getElement('raw-text-input').addEventListener('input', checkAndAutoStartAnalysis);
    getElement('input-caseName').addEventListener('input', checkAndAutoStartAnalysis);
    getElement('input-frist').addEventListener('change', checkAndAutoStartAnalysis); // Change f√ºr das Frist-Feld

    // --- KI CHAT HANDLER ---
    
    const chatInput = getElement('chat-input');
    const sendBtn = getElement('send-chat-btn');
    const dropZone = getElement('chat-drop-zone');

    // 1. Normaler File-Upload-Handler (f√ºr den Button)
    getElement('ai-file-upload').addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            fileToBase64(e.target.files[0]);
        } else {
            clearFileSelection();
        }
    });

    getElement('clear-file-btn').addEventListener('click', clearFileSelection);

    sendBtn.addEventListener('click', handleChatSubmit);
    
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !isKiProcessing) { // Globale Sperre pr√ºfen
            handleChatSubmit();
        }
    });
    
    // Aktiviert Sende-Button, wenn Text eingegeben wird (auch wenn kein File hochgeladen)
    chatInput.addEventListener('input', () => {
        // Sperrung h√§ngt von isKiProcessing UND von Text/File ab
        sendBtn.disabled = isKiProcessing || (chatInput.value.trim() === '' && !uploadedFileBase64);
    });
    // Initialer Check, falls File geladen wurde
    if (uploadedFileBase64) { sendBtn.disabled = false; }


    // 2. Drag-and-Drop Handler
    
    // Verhindere Standardverhalten und zeige Feedback
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.add('drop-zone-active');
    });
    
    // Entferne Feedback, wenn Maus die Zone verl√§sst
    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        // Stelle sicher, dass dragexit nicht bei Kindelementen feuert
        if (e.target === dropZone) {
            dropZone.classList.remove('drop-zone-active');
        }
    });
    
    // Datei verarbeiten, wenn sie fallengelassen wird
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.remove('drop-zone-active');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            // Wir verarbeiten nur die erste Datei
            fileToBase64(files[0]);
        } else {
            showStatus("Es wurden keine g√ºltigen Dateien gefunden.", true);
        }
    });


    // KORREKTUR: Listener f√ºr Akkordeon-Logik (Strategie) muss global gesetzt werden
    getElement('consequences-container').addEventListener('click', (e) => {
        const header = e.target.closest('.accordion-header');
        if (header) {
            const targetId = header.getAttribute('data-target-id');
            const body = document.getElementById(targetId); // Verwende document, da getElement einen Fehler wirft, wenn es nicht da ist
            const arrow = header.querySelector('[data-arrow-id]');

            if (body && arrow) { // Absicherung
                if (body.classList.contains('hidden')) {
                    body.classList.remove('hidden');
                    arrow.classList.add('rotate-45');
                    arrow.textContent = '‚Äì';
                } else {
                    body.classList.add('hidden');
                    arrow.classList.remove('rotate-45');
                     arrow.textContent = '+';
                }
            }
        }
    });

    // Initialisierung
    initializeFirebase();
    // KORREKTUR: Lade Demo-Daten beim Start, damit die Felder gef√ºllt sind
    loadCaseData(demoData, demoRawText); 
    setActiveSection('overview');
});
</script>
</body>
</html>
